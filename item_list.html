<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>瀏覽商品 - 二手交易平台</title>
  <link rel="stylesheet" href="ItemDetailPage.css">
  <style>
    /* Additional styles for item list page */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }

    .standalone-note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      margin: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    /* Header search input */
    .header-search {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-search input {
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      width: 200px;
      transition: all 0.2s;
    }

    .header-search input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .header-search input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .header-search button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .header-search button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    @media (max-width: 768px) {
      .header-search {
        display: none;
      }
    }

    /* Item List Page Layout */
    .item-list-page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    .item-list-layout {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* Search Bar */
    .item-search-bar {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 24px;
    }

    .item-list-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      color: #111827;
    }

    .item-search-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      flex: 1;
      max-width: 600px;
    }

    .item-search-controls select {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    .item-search-controls input[type="text"] {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }

    .item-search-controls input[type="text"]:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    /* Filter Tabs */
    .item-filter-tabs {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      margin-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
      overflow-x: auto;
    }

    .filter-tab {
      padding: 8px 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .filter-tab:hover {
      background: #f3f4f6;
      color: #111827;
    }

    .filter-tab.active {
      color: #2563eb;
      font-weight: 600;
      background: #eff6ff;
      border-bottom: 2px solid #2563eb;
    }

    /* Main Content Layout */
    .item-list-main {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 24px;
      margin-top: 16px;
    }

    /* Sidebar */
    .item-list-sidebar {
      background: #ffffff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-section:last-child {
      margin-bottom: 0;
    }

    .sidebar-section h3 {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: #111827;
    }

    .sidebar-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-section li {
      margin-bottom: 8px;
    }

    .sidebar-section label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #374151;
      cursor: pointer;
    }

    .sidebar-section input[type="radio"],
    .sidebar-section input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    /* Results Section */
    .item-list-results {
      display: flex;
      flex-direction: column;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: #6b7280;
    }

    .results-sort {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .results-sort label {
      font-size: 14px;
      color: #6b7280;
    }

    .results-sort select {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      cursor: pointer;
    }

    /* Item Card Grid */
    .item-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 16px;
    }

    .item-card {
      display: flex;
      flex-direction: column;
      border-radius: 16px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.06);
      text-decoration: none;
      color: inherit;
      overflow: hidden;
      transition: all 0.2s;
    }

    .item-card:hover {
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.1);
      transform: translateY(-2px);
    }

    .item-card-image-wrapper {
      position: relative;
      background: #f3f4f6;
      width: 100%;
    }

    .item-card-image {
      width: 100%;
      aspect-ratio: 4 / 3;
      object-fit: cover;
      display: block;
    }

    .item-card-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #2563eb;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
    }

    .item-card-body {
      padding: 10px 12px 12px;
    }

    .item-card-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      color: #111827;
    }

    .item-card-price {
      font-size: 15px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 4px;
    }

    .item-card-modes {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
    }

    .mode-pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      font-weight: 500;
    }

    .mode-purchase {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .mode-trade {
      background: #ecfdf3;
      color: #15803d;
    }

    .mode-wish {
      background: #fef3c7;
      color: #92400e;
    }

    .item-card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    /* Pagination */
    .results-pagination {
      display: flex;
      justify-content: center;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    /* Buttons */
    .btn-primary {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-outline {
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid #2563eb;
      background: #ffffff;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-outline:hover {
      background: #eff6ff;
    }

    /* Responsive */
    @media (max-width: 960px) {
      .item-list-main {
        grid-template-columns: 1fr;
      }

      .item-list-sidebar {
        position: static;
      }

      .item-search-bar {
        flex-direction: column;
        align-items: stretch;
      }

      .item-search-controls {
        max-width: 100%;
      }
    }

    @media (max-width: 640px) {
      .item-card-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
      }

      .item-filter-tabs {
        gap: 4px;
      }

      .filter-tab {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="standalone-note">
    <strong>注意：</strong>這是獨立 HTML 版本，用於快速預覽。完整功能請使用 React 版本
  </div>

  <!-- Header -->
  <header class="site-header">
    <div class="header-content">
      <a href="index.html" class="logo site-logo">
        <img src="logo.png" alt="二手交易平台 Logo" />
      </a>
      <nav class="header-nav">
        <a href="index.html">首頁</a>
        <a href="item_list.html" class="active">分類</a>
        <a href="sell.html">賣東西</a>
        <a href="chat.html">聊天</a>
      </nav>
      <div class="header-actions">
        <div class="header-search">
          <input type="text" id="headerSearchInput" placeholder="搜尋商品…">
          <button onclick="handleHeaderSearch()">搜尋</button>
        </div>
        <!-- Cart and profile icons will be populated by navbar.js -->
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="breadcrumb">
      <a href="index.html">首頁</a> / <a href="item_list.html">分類</a> / <span id="breadcrumbCurrent">商品列表</span>
    </div>

    <div class="item-list-page">
      <div class="item-list-layout">
        <!-- Search Bar -->
        <section class="item-search-bar">
          <h1 class="item-list-title">瀏覽商品</h1>
          <div id="currentFilterDisplay" style="font-size: 14px; color: #6b7280; margin-top: 8px;"></div>
          <div class="item-search-controls">
            <select id="categoryFilter">
              <option value="all">所有分類</option>
              <!-- Options will be populated by JavaScript -->
            </select>
            <input
              id="searchInput"
              type="text"
              placeholder="搜尋商品名稱或關鍵字..."
            />
            <button id="searchButton" class="btn-primary">搜尋</button>
          </div>
        </section>

        <!-- Filter Tabs -->
        <nav class="item-filter-tabs">
          <button class="filter-tab active" data-filter="all">全部</button>
          <button class="filter-tab" data-filter="newest">最新上架</button>
          <button class="filter-tab" data-filter="price_asc">價格由低到高</button>
          <button class="filter-tab" data-filter="price_desc">價格由高到低</button>
          <button class="filter-tab" data-filter="purchase_only">只看可購買</button>
          <button class="filter-tab" data-filter="trade_only">只看可交換</button>
        </nav>

        <!-- Main Content -->
        <div class="item-list-main">
          <!-- Left Sidebar -->
          <aside class="item-list-sidebar">
            <section class="sidebar-section">
              <h3>類別</h3>
              <ul id="sidebarCategoryList">
                <li><label><input type="radio" name="sidebarCategory" value="all" checked> 全部</label></li>
                <!-- Options will be populated by JavaScript -->
              </ul>
            </section>

            <section class="sidebar-section">
              <h3>交易方式</h3>
              <ul>
                <li><label><input type="checkbox" id="filterPurchase"> 可購買</label></li>
                <li><label><input type="checkbox" id="filterTrade"> 可交換</label></li>
                <li><label><input type="checkbox" id="filterWish"> 開放式許願</label></li>
              </ul>
            </section>

            <section class="sidebar-section">
              <h3>商品狀況</h3>
              <ul>
                <li><label><input type="checkbox" value="new" class="condition-filter"> 全新</label></li>
                <li><label><input type="checkbox" value="like_new" class="condition-filter"> 九成新</label></li>
                <li><label><input type="checkbox" value="used" class="condition-filter"> 二手</label></li>
              </ul>
            </section>
          </aside>

          <!-- Right Results -->
          <section class="item-list-results">
            <div class="results-header">
              <span id="resultsCount">共 0 筆結果</span>
              <div class="results-sort">
                <label for="sortSelect">排序：</label>
                <select id="sortSelect">
                  <option value="default">預設</option>
                  <option value="newest">最新上架</option>
                  <option value="price_asc">價格由低到高</option>
                  <option value="price_desc">價格由高到低</option>
                </select>
              </div>
            </div>

            <div class="item-card-grid" id="itemCardGrid">
              <!-- Items will be rendered here by JavaScript -->
            </div>

            <div class="results-pagination">
              <button class="btn-outline" id="loadMoreButton">載入更多</button>
            </div>
          </section>
        </div>
      </div>
    </div>
  </main>

  <script src="js/data.js"></script>
  <script src="js/images.js"></script>
  <script src="js/categories.js"></script>
  <script src="js/navbar.js"></script>
  <script>
    // State
    let currentItems = [];
    let currentFilter = 'all';
    let currentSort = 'default';
    let displayedCount = 8;
    const itemsPerPage = 8;
    
    // Load items from data layer
    function loadItems() {
      let items = getItems().filter(i => i.isActive);
      
      // Convert to old format for compatibility
      items = items.map(item => {
        const seller = getUsers().find(u => u.id === item.sellerId);
        return {
          id: item.id,
          title: item.title,
          price: item.price,
          category: item.category,
          condition: item.condition,
          location: item.location,
          tags: item.tags || [],
          images: item.images || [],
          description: item.description,
          stats: {
            views: item.views || 0,
            watchers: item.addedToCartCount || 0
          },
          mode: {
            purchase: item.modes?.sale || false,
            trade: item.modes?.tradeTarget || item.modes?.tradeOpen || false,
            wish: item.modes?.tradeOpen || false,
            tradeMode: item.modes?.tradeTarget && item.modes?.tradeOpen ? 'both' :
                      item.modes?.tradeTarget ? 'target' :
                      item.modes?.tradeOpen ? 'offer' : null,
            tradeSummary: item.tradeTargetNote || ''
          },
          seller: seller ? {
            name: seller.name,
            rating: 4.8,
            ratingText: '99.9% 好評',
            deals: 0
          } : {
            name: 'Unknown',
            rating: 0,
            ratingText: '無評價',
            deals: 0
          }
        };
      });
      
      // Fallback to mockItems if available
      if (items.length === 0 && typeof mockItems !== 'undefined') {
        items = [...mockItems];
      }
      
      return items;
    }
    
    currentItems = loadItems();

    // Category data structure - using official category names directly
    const categories = [
      { id: 'textbooks', label: '課本／學習用品', itemCategory: '課本／學習用品' },
      { id: 'laptop_3c', label: '筆電／3C', itemCategory: '筆電／3C' },
      { id: 'phone_tablet', label: '手機／平板', itemCategory: '手機／平板' },
      { id: 'game_console', label: '遊戲與主機', itemCategory: '遊戲與主機' },
      { id: 'dorm_furniture', label: '宿舍家電與家具', itemCategory: '宿舍家電與家具' },
      { id: 'clothing_life', label: '服飾／生活用品', itemCategory: '服飾／生活用品' },
      { id: 'sports_hobby', label: '運動／興趣嗜好', itemCategory: '運動／興趣嗜好' },
      { id: 'others', label: '其他', itemCategory: '其他' }
    ];

    // Map category IDs to official category names for filtering
    const urlCategoryMap = {};
    categories.forEach(cat => {
      urlCategoryMap[cat.id] = cat.itemCategory;
    });

    // Populate category dropdown
    function populateCategoryDropdown() {
      const select = document.getElementById('categoryFilter');
      if (!select) return;

      // Keep "所有分類" option
      const allOption = select.querySelector('option[value="all"]');
      select.innerHTML = '';
      if (allOption) {
        select.appendChild(allOption);
      } else {
        const defaultOption = document.createElement('option');
        defaultOption.value = 'all';
        defaultOption.textContent = '所有分類';
        select.appendChild(defaultOption);
      }

      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.label;
        select.appendChild(option);
      });
    }

    // Populate sidebar category list
    function populateSidebarCategories() {
      const sidebarList = document.getElementById('sidebarCategoryList');
      if (!sidebarList) return;

      // Keep "全部" option
      const allItem = sidebarList.querySelector('li:first-child');
      sidebarList.innerHTML = '';
      if (allItem) {
        sidebarList.appendChild(allItem);
      } else {
        const allLi = document.createElement('li');
        allLi.innerHTML = '<label><input type="radio" name="sidebarCategory" value="all" checked> 全部</label>';
        sidebarList.appendChild(allLi);
      }

      categories.forEach(category => {
        const li = document.createElement('li');
        li.innerHTML = `<label><input type="radio" name="sidebarCategory" value="${category.id}"> ${category.label}</label>`;
        sidebarList.appendChild(li);
      });
    }

    // Condition mapping for old data structure compatibility
    const conditionMap = {
      'new': '全新',
      'like_new': '九成新',
      'used': '二手'
    };

    // Create item card
    function createItemCard(item) {
      const a = document.createElement('a');
      a.href = `item_page.html?id=${encodeURIComponent(item.id)}`;
      a.className = 'item-card';
      a.setAttribute('data-id', item.id);

      const purchaseLabel = item.mode.purchase ? '可購買' : '';
      const tradeLabel = item.mode.trade ? '可交換' : '';
      const wishLabel = item.mode.wish ? '開放式許願' : '';

      let priceText = '';
      if (item.mode.purchase) {
        priceText = `NT$ ${item.price.toLocaleString('zh-TW')}`;
      } else if (item.mode.trade && !item.mode.purchase) {
        priceText = '僅接受以物易物';
      } else if (item.mode.wish && !item.mode.purchase) {
        priceText = '許願中';
      }

      a.innerHTML = `
        <div class="item-card-image-wrapper">
          <img src="${getProductImageUrl(item)}" alt="${item.title}" class="item-card-image">
          <span class="item-card-badge">${item.condition}</span>
        </div>
        <div class="item-card-body">
          <h3 class="item-card-title">${item.title}</h3>
          <div class="item-card-price">${priceText}</div>
          <div class="item-card-modes">
            ${purchaseLabel ? `<span class="mode-pill mode-purchase">${purchaseLabel}</span>` : ''}
            ${tradeLabel ? `<span class="mode-pill mode-trade">${tradeLabel}</span>` : ''}
            ${wishLabel ? `<span class="mode-pill mode-wish">${wishLabel}</span>` : ''}
          </div>
          <div class="item-card-meta">
            <span class="item-card-location">${item.location}</span>
            <span class="item-card-seller">${item.seller.name}</span>
          </div>
        </div>
      `;
      
      // Attach fallback to the image
      const img = a.querySelector('.item-card-image');
      if (img) attachImageFallback(img);
      
      return a;
    }

    // Render items
    function renderList(items) {
      const grid = document.getElementById('itemCardGrid');
      grid.innerHTML = '';

      const itemsToShow = items.slice(0, displayedCount);

      itemsToShow.forEach(item => {
        grid.appendChild(createItemCard(item));
      });

      // Update result count
      document.getElementById('resultsCount').textContent = `共 ${items.length} 筆結果`;

      // Show/hide load more button
      const loadMoreBtn = document.getElementById('loadMoreButton');
      if (itemsToShow.length < items.length) {
        loadMoreBtn.style.display = 'block';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    // Filter and sort items
    function filterAndSortItems() {
      let filtered = loadItems();

      // Read URL params first
      const urlParams = new URLSearchParams(window.location.search);
      const urlQ = urlParams.get('q');
      const urlCategory = urlParams.get('category');

      // Update search input from URL
      if (urlQ) {
        document.getElementById('searchInput').value = urlQ;
      }

      // Update category filter from URL
      if (urlCategory) {
        // Use the new category ID directly (no mapping needed for UI)
        document.getElementById('categoryFilter').value = urlCategory;
        const sidebarRadio = document.querySelector(`input[name="sidebarCategory"][value="${urlCategory}"]`);
        if (sidebarRadio) sidebarRadio.checked = true;
      }

      // Category filter (from dropdown, sidebar, or URL)
      const categoryFilter = document.getElementById('categoryFilter').value;
      const sidebarCategory = document.querySelector('input[name="sidebarCategory"]:checked')?.value;
      const activeCategoryId = sidebarCategory && sidebarCategory !== 'all' ? sidebarCategory : categoryFilter;

      if (activeCategoryId !== 'all') {
        // Map new category ID to item.category value
        const mappedCategory = urlCategoryMap[activeCategoryId] || activeCategoryId;
        // Normalize categories for comparison (handle old category values)
        filtered = filtered.filter(item => {
          const normalizedItemCategory = normalizeCategory(item.category);
          return normalizedItemCategory === mappedCategory;
        });
      }

      // Search filter (from input or URL)
      const searchTerm = (urlQ || document.getElementById('searchInput').value).toLowerCase().trim();
      if (searchTerm) {
        filtered = filtered.filter(item => 
          item.title.toLowerCase().includes(searchTerm) ||
          item.tags.some(tag => tag.toLowerCase().includes(searchTerm)) ||
          item.seller.name.toLowerCase().includes(searchTerm)
        );
      }

      // Show current filter info
      updateFilterDisplay(urlQ, urlCategory, activeCategoryId);

      // Mode filters
      const filterPurchase = document.getElementById('filterPurchase').checked;
      const filterTrade = document.getElementById('filterTrade').checked;
      const filterWish = document.getElementById('filterWish').checked;

      if (filterPurchase || filterTrade || filterWish) {
        filtered = filtered.filter(item => {
          if (filterPurchase && !item.mode.purchase) return false;
          if (filterTrade && !item.mode.trade) return false;
          if (filterWish && !item.mode.wish) return false;
          return true;
        });
      }

      // Condition filters - map to new structure
      const conditionFilters = Array.from(document.querySelectorAll('.condition-filter:checked')).map(cb => {
        if (cb.value === 'new') return '全新';
        if (cb.value === 'like_new') return '九成新';
        if (cb.value === 'used') return '二手';
        return cb.value;
      });
      if (conditionFilters.length > 0) {
        filtered = filtered.filter(item => conditionFilters.includes(item.condition));
      }

      // Tab filters
      if (currentFilter === 'purchase_only') {
        filtered = filtered.filter(item => item.mode.purchase);
      } else if (currentFilter === 'trade_only') {
        filtered = filtered.filter(item => item.mode.trade);
      }

      // Sort
      if (currentSort === 'newest' || currentFilter === 'newest') {
        // Note: new data structure doesn't have createdAt, skip for now
        // filtered.sort((a, b) => b.createdAt - a.createdAt);
      } else if (currentSort === 'price_asc' || currentFilter === 'price_asc') {
        filtered.sort((a, b) => a.price - b.price);
      } else if (currentSort === 'price_desc' || currentFilter === 'price_desc') {
        filtered.sort((a, b) => b.price - a.price);
      }

      currentItems = filtered;
      displayedCount = itemsPerPage;
      renderList(currentItems);
      
      // Update URL params
      updateURLParams();
    }

    // Update filter display
    function updateFilterDisplay(searchTerm, urlCategory, activeCategoryId) {
      const display = document.getElementById('currentFilterDisplay');
      const parts = [];
      
      if (searchTerm) {
        parts.push(`搜尋關鍵字：「${searchTerm}」`);
      }
      
      if (urlCategory || (activeCategoryId && activeCategoryId !== 'all')) {
        const categoryId = urlCategory || activeCategoryId;
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          parts.push(`分類：${category.label}`);
        }
      }
      
      if (parts.length > 0) {
        display.textContent = parts.join('｜');
        display.style.display = 'block';
      } else {
        display.style.display = 'none';
      }
    }

    // Update URL parameters
    function updateURLParams() {
      const params = new URLSearchParams();
      const searchTerm = document.getElementById('searchInput').value.trim();
      const category = document.getElementById('categoryFilter').value;
      
      if (searchTerm) params.set('q', searchTerm);
      if (category !== 'all') {
        // Use the new category ID directly in URL
        params.set('category', category);
      }
      if (currentFilter !== 'all') params.set('filter', currentFilter);
      if (currentSort !== 'default') params.set('sort', currentSort);
      
      const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.history.replaceState({}, '', newURL);
    }

    // Read URL parameters on load
    function readURLParams() {
      const params = new URLSearchParams(window.location.search);
      
      const q = params.get('q');
      if (q) {
        document.getElementById('searchInput').value = q;
      }
      
      const category = params.get('category');
      if (category) {
        // Use the new category ID directly
        const categorySelect = document.getElementById('categoryFilter');
        if (categorySelect && categorySelect.querySelector(`option[value="${category}"]`)) {
          categorySelect.value = category;
        }
        const sidebarRadio = document.querySelector(`input[name="sidebarCategory"][value="${category}"]`);
        if (sidebarRadio) sidebarRadio.checked = true;
      }
      
      // Also check old 'cat' param for backward compatibility
      const cat = params.get('cat');
      if (cat && !category) {
        // Try to map old category to new category ID
        const oldToNewMap = {
          'games': 'game_console',
          'electronics': 'laptop_3c',
          'books': 'textbooks',
          'others': 'others'
        };
        const newCategoryId = oldToNewMap[cat] || cat;
        const categorySelect = document.getElementById('categoryFilter');
        if (categorySelect && categorySelect.querySelector(`option[value="${newCategoryId}"]`)) {
          categorySelect.value = newCategoryId;
        }
        const sidebarRadio = document.querySelector(`input[name="sidebarCategory"][value="${newCategoryId}"]`);
        if (sidebarRadio) sidebarRadio.checked = true;
      }
      
      // Also check old 'cat' param for backward compatibility
      const cat = params.get('cat');
      if (cat && !category) {
        document.getElementById('categoryFilter').value = cat;
        const sidebarRadio = document.querySelector(`input[name="sidebarCategory"][value="${cat}"]`);
        if (sidebarRadio) sidebarRadio.checked = true;
      }
      
      const filter = params.get('filter');
      if (filter) {
        currentFilter = filter;
        document.querySelectorAll('.filter-tab').forEach(tab => {
          if (tab.dataset.filter === filter) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });
      }
      
      const sort = params.get('sort');
      if (sort) {
        currentSort = sort;
        document.getElementById('sortSelect').value = sort;
      }
    }

    // Event listeners
    document.getElementById('searchButton').addEventListener('click', filterAndSortItems);
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        filterAndSortItems();
      }
    });

    document.getElementById('categoryFilter').addEventListener('change', filterAndSortItems);
    document.getElementById('sortSelect').addEventListener('change', (e) => {
      currentSort = e.target.value;
      filterAndSortItems();
    });

    // Sidebar filters
    document.querySelectorAll('input[name="sidebarCategory"]').forEach(radio => {
      radio.addEventListener('change', filterAndSortItems);
    });

    document.getElementById('filterPurchase').addEventListener('change', filterAndSortItems);
    document.getElementById('filterTrade').addEventListener('change', filterAndSortItems);
    document.getElementById('filterWish').addEventListener('change', filterAndSortItems);

    document.querySelectorAll('.condition-filter').forEach(checkbox => {
      checkbox.addEventListener('change', filterAndSortItems);
    });

    // Filter tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        currentFilter = e.target.dataset.filter;
        filterAndSortItems();
      });
    });

    // Load more
    document.getElementById('loadMoreButton').addEventListener('click', () => {
      displayedCount += itemsPerPage;
      renderList(currentItems);
    });

    // Handle header search
    function handleHeaderSearch() {
      const keyword = document.getElementById('headerSearchInput').value.trim();
      const params = new URLSearchParams();
      if (keyword) params.set('q', keyword);
      window.location.href = 'item_list.html?' + params.toString();
    }

    // Allow Enter key in header search
    document.addEventListener('DOMContentLoaded', () => {
      const headerSearchInput = document.getElementById('headerSearchInput');
      if (headerSearchInput) {
        headerSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleHeaderSearch();
          }
        });
      }
    });

    // Initialize categories and then load
    document.addEventListener('DOMContentLoaded', () => {
      populateCategoryDropdown();
      populateSidebarCategories();
      
      // Re-attach sidebar event listeners after populating
      document.querySelectorAll('input[name="sidebarCategory"]').forEach(radio => {
        radio.addEventListener('change', filterAndSortItems);
      });
      
      // Initial load: read URL params and render
      readURLParams();
      filterAndSortItems();
    });
  </script>
</body>
</html>

