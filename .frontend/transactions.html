<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>交易紀錄 - 二手交易平台</title>
  <link rel="stylesheet" href="ItemDetailPage.css?v=v1.0.0">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }

    .transactions-page {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 40px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 20px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .transaction-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .transaction-card {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      gap: 20px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .transaction-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .transaction-image {
      width: 120px;
      height: 120px;
      border-radius: 12px;
      object-fit: cover;
      background: #f3f4f6;
    }

    .transaction-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .transaction-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }

    .transaction-title a {
      color: inherit;
      text-decoration: none;
    }

    .transaction-title a:hover {
      color: #2563eb;
      text-decoration: underline;
    }

    .transaction-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      font-size: 14px;
      color: #6b7280;
    }

    .transaction-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }

    .role-buyer {
      background: #dbeafe;
      color: #1d4ed8;
    }

    .role-seller {
      background: #ecfdf3;
      color: #15803d;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .transaction-card {
        grid-template-columns: 1fr;
      }

      .transaction-image {
        width: 100%;
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-content">
      <a href="index.html" class="logo site-logo">
        <img src="logo.png" alt="二手交易平台 Logo" />
      </a>
      <nav class="header-nav">
        <a href="index.html">首頁</a>
        <a href="item_list.html">分類</a>
        <a href="sell.html">賣東西</a>
        <a href="chat.html">聊天</a>
      </nav>
      <div class="header-actions">
        <!-- Will be populated by navbar.js -->
      </div>
    </div>
  </header>

  <main>
    <div class="transactions-page">
      <div class="page-header">
        <h1>交易紀錄</h1>
      </div>

      <div class="section">
        <h2 class="section-title">我買到的商品</h2>
        <div id="boughtItems" class="transaction-list">
          <!-- Will be rendered here -->
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">我賣出的商品</h2>
        <div id="soldItems" class="transaction-list">
          <!-- Will be rendered here -->
        </div>
      </div>

      <div class="section">
        <h2 class="section-title">已拒絕 / 已取消的請求</h2>
        <div id="rejectedItems" class="transaction-list">
          <!-- Will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <script src="js/api.js?v=v1.0.0"></script>
  <script src="js/data.js?v=v1.0.0"></script>
  <script src="js/auth_check.js?v=v1.0.0"></script>
  <script src="js/images.js?v=v1.0.0"></script>
  <script src="js/navbar.js?v=v1.0.0"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Render transaction card
      function renderTransactionCard(transaction) {
        const card = document.createElement('div');
        card.className = 'transaction-card';
        
        const completeDate = transaction.complete_date ? new Date(transaction.complete_date) : new Date();
        const dateStr = completeDate.toLocaleString('zh-TW', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const role = transaction.is_buyer ? 'buyer' : 'seller';
        const roleText = transaction.is_buyer ? '我是買家' : '我是賣家';
        
        let priceInfo = '';
        if (transaction.request_type === 'Purchase' && transaction.total_price) {
          priceInfo = `NT$ ${Number(transaction.total_price).toLocaleString('zh-TW')}`;
        } else if (transaction.request_type === 'Trade') {
          priceInfo = transaction.offered_product_name 
            ? `交換：${transaction.offered_product_name}` 
            : '交換提案';
        }
        
        const productImage = transaction.target_product_image || '';
        
        card.innerHTML = `
          <img src="${getProductImageUrl({ image_url: productImage, product_name: transaction.target_product_name })}" 
               alt="${transaction.target_product_name}" 
               class="transaction-image">
          <div class="transaction-info">
            <h3 class="transaction-title">
              <a href="item_page.html?id=${transaction.target_product_id}">${transaction.target_product_name}</a>
            </h3>
            <div class="transaction-meta">
              <div>
                <span class="role-badge ${role === 'buyer' ? 'role-buyer' : 'role-seller'}">
                  ${roleText}
                </span>
              </div>
              <div><strong>對方：</strong>${transaction.other_user_name || '未知使用者'}</div>
              <div><strong>完成日期：</strong>${dateStr}</div>
              ${priceInfo ? `<div><strong>成交內容：</strong>${priceInfo}</div>` : ''}
            </div>
          </div>
          <div class="transaction-actions">
            <button class="btn-small btn-chat" onclick="openChatByRequestId(${transaction.request_id})">查看對話</button>
          </div>
        `;
        
        // Attach fallback to the image
        const img = card.querySelector('.transaction-image');
        if (img) attachImageFallback(img);
        
        return card;
      }

      // Render transactions
      async function renderTransactions() {
        const boughtContainer = document.getElementById('boughtItems');
        const soldContainer = document.getElementById('soldItems');
        const rejectedContainer = document.getElementById('rejectedItems');
        
        // 顯示載入中
        boughtContainer.innerHTML = '<div class="empty-state">載入中...</div>';
        soldContainer.innerHTML = '<div class="empty-state">載入中...</div>';
        rejectedContainer.innerHTML = '<div class="empty-state">載入中...</div>';
        
        try {
          // 從 API 獲取交易記錄
          const transactions = await api.getTransactions();
          console.log('獲取到的交易記錄:', transactions);
          
          // 分離買到的和賣出的
          const bought = transactions.filter(t => t.is_buyer);
          const sold = transactions.filter(t => t.is_seller);
          
          // 獲取已拒絕/已取消的請求（從 trade_requests API）
          let rejected = [];
          try {
            const sentRequests = await api.getTradeRequests({ type: 'sent' });
            const receivedRequests = await api.getTradeRequests({ type: 'received' });
            const allRequests = [...sentRequests, ...receivedRequests];
            rejected = allRequests.filter(r => 
              r.status === 'Rejected' || r.status === 'Cancelled'
            );
          } catch (error) {
            console.warn('獲取已拒絕/已取消的請求失敗:', error);
          }
          
          // Render bought
          if (bought.length === 0) {
            boughtContainer.innerHTML = '<div class="empty-state">還沒有買到的商品</div>';
          } else {
            boughtContainer.innerHTML = '';
            bought.forEach(transaction => {
              const card = renderTransactionCard(transaction);
              if (card) boughtContainer.appendChild(card);
            });
          }
          
          // Render sold
          if (sold.length === 0) {
            soldContainer.innerHTML = '<div class="empty-state">還沒有賣出的商品</div>';
          } else {
            soldContainer.innerHTML = '';
            sold.forEach(transaction => {
              const card = renderTransactionCard(transaction);
              if (card) soldContainer.appendChild(card);
            });
          }
          
          // Render rejected
          if (rejected.length === 0) {
            rejectedContainer.innerHTML = '<div class="empty-state">沒有已拒絕或已取消的請求</div>';
          } else {
            rejectedContainer.innerHTML = '';
            // 對於已拒絕/已取消的請求，需要獲取商品資訊
            for (const request of rejected) {
              try {
                const product = await api.getProduct(request.target_product_id);
                if (product) {
                  const transactionCard = {
                    request_id: request.request_id,
                    target_product_id: request.target_product_id,
                    target_product_name: product.product_name,
                    target_product_image: product.image_url,
                    complete_date: request.updated_at || request.created_at,
                    is_buyer: String(request.requester_id) === String(api.getUserId()),
                    is_seller: String(request.owner_id) === String(api.getUserId()),
                    other_user_id: String(request.requester_id) === String(api.getUserId()) 
                      ? request.owner_id 
                      : request.requester_id,
                    other_user_name: String(request.requester_id) === String(api.getUserId())
                      ? (request.owner_name || '未知使用者')
                      : (request.requester_name || '未知使用者'),
                    request_type: request.request_type,
                    total_price: request.offer_price,
                    offered_product_id: request.offered_product_id
                  };
                  const card = renderTransactionCard(transactionCard);
                  if (card) rejectedContainer.appendChild(card);
                }
              } catch (error) {
                console.error('獲取商品資訊失敗:', error);
              }
            }
          }
        } catch (error) {
          console.error('載入交易記錄失敗:', error);
          boughtContainer.innerHTML = '<div class="empty-state">載入失敗，請重新整理頁面</div>';
          soldContainer.innerHTML = '<div class="empty-state">載入失敗，請重新整理頁面</div>';
          rejectedContainer.innerHTML = '<div class="empty-state">載入失敗，請重新整理頁面</div>';
        }
      }

      function openChatByRequestId(requestId) {
        window.location.href = `messages.html?requestId=${requestId}`;
      }

      window.openChatByRequestId = openChatByRequestId;

      // Initial render
      await renderTransactions();
    });
  </script>
</body>
</html>

