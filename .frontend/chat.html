<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èŠå¤© - äºŒæ‰‹äº¤æ˜“å¹³å°</title>
  <link rel="stylesheet" href="ItemDetailPage.css?v=v1.0.0">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }

    .chat-page {
      padding: 32px 48px;
    }

    .chat-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto 48px;
    }

    .chat-sidebar {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 35, 95, 0.08);
      padding: 16px 0;
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }

    .chat-title {
      font-size: 18px;
      font-weight: 600;
      padding: 0 24px 16px;
      color: #111827;
      margin: 0;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 8px;
    }

    .conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    .conversation-item {
      width: 100%;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .conversation-item:hover {
      background-color: #f5f7ff;
    }

    .conversation-item-active {
      background-color: #e6edff;
    }

    .conversation-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e6edff;
      color: #2563eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
      flex-shrink: 0;
    }

    .conversation-text {
      flex: 1;
      text-align: left;
      min-width: 0;
    }

    .conversation-seller {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .conversation-preview {
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-time {
      font-size: 11px;
      color: #9ca3af;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .chat-thread {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 35, 95, 0.08);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
    }

    .chat-thread-header {
      padding: 16px 24px;
      border-bottom: 1px solid #e5e7eb;
    }

    .chat-thread-seller {
      font-weight: 600;
      font-size: 16px;
      color: #111827;
      margin-bottom: 4px;
    }

    .chat-thread-item {
      font-size: 13px;
      color: #6b7280;
    }

    .chat-messages {
      padding: 16px 24px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .chat-message {
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }

    .chat-message-seller {
      align-self: flex-start;
      text-align: left;
    }

    .chat-message-user {
      align-self: flex-end;
      text-align: right;
    }

    .chat-bubble {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .chat-message-seller .chat-bubble {
      background-color: #f5f7ff;
      color: #111827;
    }

    .chat-message-user .chat-bubble {
      background-color: #2563eb;
      color: #ffffff;
    }

    .chat-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
      padding: 0 4px;
    }

    .chat-input-area {
      display: flex;
      padding: 12px 16px;
      border-top: 1px solid #e5e7eb;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 10px 16px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }

    .chat-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .chat-send-btn {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background-color: #2563eb;
      color: #ffffff;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .chat-send-btn:hover {
      background-color: #1d4ed8;
    }

    .chat-empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
      text-align: center;
      padding: 40px;
    }

    .chat-empty-state p {
      margin: 8px 0;
      font-size: 14px;
    }

    @media (max-width: 960px) {
      .chat-container {
        grid-template-columns: 1fr;
      }

      .chat-sidebar {
        height: auto;
        max-height: 400px;
      }

      .chat-thread {
        height: 600px;
      }

      .chat-page {
        padding: 24px 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-content">
      <a href="index.html" class="logo site-logo">
        <img src="logo.png" alt="äºŒæ‰‹äº¤æ˜“å¹³å° Logo" />
      </a>
      <nav class="header-nav">
        <a href="index.html">é¦–é </a>
        <a href="item_list.html">åˆ†é¡</a>
        <a href="sell.html">è³£æ±è¥¿</a>
        <a href="chat.html" class="active">èŠå¤©</a>
      </nav>
      <div class="header-actions">
        <!-- Navbar will be populated by js/navbar.js -->
      </div>
    </div>
  </header>

  <main class="chat-page">
    <div class="chat-container">
      <section class="chat-sidebar">
        <h2 class="chat-title">èŠå¤©</h2>
        <div class="conversation-list" id="conversationList">
          <!-- Conversations will be populated by JavaScript -->
          <div class="chat-empty-state">
            <p>ç›®å‰æ²’æœ‰å°è©±</p>
            <p style="font-size: 12px; color: #9ca3af;">é–‹å§‹ç€è¦½å•†å“ä¸¦è¯çµ¡è³£å®¶å§ï¼</p>
          </div>
        </div>
      </section>

      <section class="chat-thread" id="chatThread">
        <div class="chat-empty-state">
          <p>é¸æ“‡å·¦å´çš„å°è©±é–‹å§‹èŠå¤©</p>
        </div>
      </section>
    </div>
  </main>

  <script src="js/api.js?v=v1.0.0"></script>
  <script src="js/data.js?v=v1.0.0"></script>
  <script src="js/auth_check.js?v=v1.0.0"></script>
  <script src="js/navbar.js?v=v1.0.0"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const conversationList = document.getElementById('conversationList');
      const chatThread = document.getElementById('chatThread');
      const currentUser = getCurrentUser();
      const currentUserId = api ? api.getUserId() : (currentUser ? currentUser.id : null);

      if (!currentUserId) {
        conversationList.innerHTML = '<div class="chat-empty-state"><p>è«‹å…ˆç™»å…¥</p></div>';
        return;
      }

      // Load conversations from API (based on trade requests)
      async function loadConversations() {
        conversationList.innerHTML = '<div class="chat-empty-state"><p>è¼‰å…¥ä¸­...</p></div>';
        
        try {
          // ç²å–æ‰€æœ‰äº¤æ˜“è«‹æ±‚ï¼ˆæˆ‘æå‡ºçš„å’Œæ”¶åˆ°çš„ï¼‰
          const sentRequests = await api.getTradeRequests({ type: 'sent' });
          const receivedRequests = await api.getTradeRequests({ type: 'received' });
          const allRequests = [...sentRequests, ...receivedRequests];
          
          // ä½¿ç”¨ Map å»é‡ï¼Œä»¥ request_id ç‚º key
          const uniqueRequestsMap = new Map();
          allRequests.forEach(request => {
            if (!uniqueRequestsMap.has(request.request_id)) {
              uniqueRequestsMap.set(request.request_id, request);
            }
          });
          const uniqueRequests = Array.from(uniqueRequestsMap.values());
          
          if (uniqueRequests.length === 0) {
            conversationList.innerHTML = '<div class="chat-empty-state"><p>ç›®å‰æ²’æœ‰å°è©±</p><p style="font-size: 12px; color: #9ca3af;">é–‹å§‹ç€è¦½å•†å“ä¸¦è¯çµ¡è³£å®¶å§ï¼</p></div>';
            return;
          }

          // ç‚ºæ¯å€‹è«‹æ±‚å‰µå»ºå°è©±é …ç›®
          const conversations = [];
          for (const request of uniqueRequests) {
            try {
              const product = await api.getProduct(request.target_product_id);
              const isRequester = String(request.requester_id) === String(currentUserId);
              const otherUserId = isRequester
                ? (request.owner_id || null)
                : request.requester_id;
              const otherUserName = isRequester
                ? (request.owner_name || 'æœªçŸ¥ä½¿ç”¨è€…')
                : (request.requester_name || 'æœªçŸ¥ä½¿ç”¨è€…');
              
              // ç²å–æœ€å¾Œä¸€æ¢è¨Šæ¯
              let lastMessage = null;
              let lastMessageTime = request.created_at;
              try {
                const messages = await api.getMessages(request.request_id);
                if (messages && messages.length > 0) {
                  lastMessage = messages[messages.length - 1];
                  lastMessageTime = lastMessage.sent_at;
                }
              } catch (e) {
                console.log('ç²å–è¨Šæ¯å¤±æ•—:', e);
              }
              
              conversations.push({
                requestId: request.request_id,
                productId: request.target_product_id,
                productName: product.product_name,
                otherUserId: otherUserId,
                otherUserName: otherUserName,
                lastMessage: lastMessage,
                lastMessageTime: lastMessageTime,
                product: product
              });
            } catch (error) {
              console.error('è¼‰å…¥å°è©±é …ç›®å¤±æ•—:', error);
            }
          }
          
          // æŒ‰æœ€å¾Œè¨Šæ¯æ™‚é–“æ’åº
          conversations.sort((a, b) => new Date(b.lastMessageTime) - new Date(a.lastMessageTime));

          conversationList.innerHTML = '';
          conversations.forEach((conv, index) => {
            const button = document.createElement('button');
            button.className = 'conversation-item';
            button.dataset.requestId = conv.requestId;
            if (index === 0) button.classList.add('conversation-item-active');

            const avatar = document.createElement('div');
            avatar.className = 'conversation-avatar';
            avatar.textContent = conv.otherUserName[0] ? conv.otherUserName[0].toUpperCase() : '?';

            const text = document.createElement('div');
            text.className = 'conversation-text';
            text.innerHTML = `
              <div class="conversation-seller">${conv.productName} / ${conv.otherUserName}</div>
              <div class="conversation-preview">${conv.lastMessage ? conv.lastMessage.content : 'é‚„æ²’æœ‰è¨Šæ¯'}</div>
            `;

            const time = document.createElement('div');
            time.className = 'conversation-time';
            const msgDate = new Date(conv.lastMessageTime);
            const now = new Date();
            const diffMs = now - msgDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) {
              time.textContent = 'å‰›å‰›';
            } else if (diffMins < 60) {
              time.textContent = `${diffMins}åˆ†é˜å‰`;
            } else if (diffHours < 24) {
              time.textContent = `${diffHours}å°æ™‚å‰`;
            } else if (diffDays < 7) {
              time.textContent = `${diffDays}å¤©å‰`;
            } else {
              time.textContent = msgDate.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            }

            button.appendChild(avatar);
            button.appendChild(text);
            button.appendChild(time);

            button.addEventListener('click', () => {
              document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('conversation-item-active');
              });
              button.classList.add('conversation-item-active');
              loadChatThread(conv);
            });

            conversationList.appendChild(button);
          });

          // Load first conversation by default
          if (conversations.length > 0) {
            loadChatThread(conversations[0]);
          }
        } catch (error) {
          console.error('è¼‰å…¥å°è©±åˆ—è¡¨å¤±æ•—:', error);
          conversationList.innerHTML = `<div class="chat-empty-state"><p>è¼‰å…¥å¤±æ•—: ${error.message}</p></div>`;
        }
      }

      async function loadChatThread(conversation) {
        try {
          // ç²å–è«‹æ±‚è³‡è¨Šä»¥æª¢æŸ¥ç‹€æ…‹
          const sentRequests = await api.getTradeRequests({ type: 'sent' });
          const receivedRequests = await api.getTradeRequests({ type: 'received' });
          const allRequests = [...sentRequests, ...receivedRequests];
          const request = allRequests.find(r => r.request_id === conversation.requestId);
          
          // ç²å–è¨Šæ¯
          const messages = await api.getMessages(conversation.requestId);
          
          // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œå·²é¢äº¤ã€æŒ‰éˆ•
          let handoffButtonHTML = '';
          if (request && request.status === 'Accepted') {
            const isBuyer = String(request.requester_id) === String(currentUserId);
            const buyerConfirmed = Boolean(request.buyer_confirmed_handoff);
            const sellerConfirmed = Boolean(request.seller_confirmed_handoff);
            const userConfirmed = isBuyer ? buyerConfirmed : sellerConfirmed;
            const bothConfirmed = buyerConfirmed && sellerConfirmed;
            
            console.log('å·²é¢äº¤æŒ‰éˆ•åˆ¤æ–· (chat.html):', {
              requestId: conversation.requestId,
              status: request.status,
              isBuyer,
              buyerConfirmed,
              sellerConfirmed,
              userConfirmed,
              bothConfirmed
            });
            
            if (!bothConfirmed) {
              const confirmStatus = [];
              if (buyerConfirmed) confirmStatus.push('è²·å®¶å·²ç¢ºèª');
              if (sellerConfirmed) confirmStatus.push('è³£å®¶å·²ç¢ºèª');
              
              handoffButtonHTML = `
                <div class="handoff-confirmation-section" style="padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                  <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 14px; color: #6b7280;">
                      ${confirmStatus.length > 0 ? confirmStatus.join('ã€') : 'ç­‰å¾…ç¢ºèªé¢äº¤'}
                    </span>
                    <button 
                      id="confirmHandoffBtn" 
                      onclick="handleConfirmHandoff(${conversation.requestId})"
                      ${userConfirmed ? 'disabled' : ''}
                      style="padding: 8px 16px; background: ${userConfirmed ? '#9ca3af' : '#3b82f6'}; color: white; border: none; border-radius: 8px; cursor: ${userConfirmed ? 'not-allowed' : 'pointer'}; font-size: 14px; font-weight: 500;"
                    >
                      ${userConfirmed ? 'âœ“ å·²ç¢ºèªé¢äº¤' : 'ç¢ºèªå·²é¢äº¤'}
                    </button>
                  </div>
                </div>
              `;
            } else {
              handoffButtonHTML = `
                <div class="handoff-confirmation-section" style="padding: 16px; background: #d1fae5; border-bottom: 1px solid #10b981;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">âœ“</span>
                    <span style="font-size: 14px; color: #065f46; font-weight: 500;">äº¤æ˜“å·²å®Œæˆ</span>
                  </div>
                </div>
              `;
            }
          }
          
          // Build thread HTML
          chatThread.innerHTML = `
            <header class="chat-thread-header">
              <div class="chat-thread-seller">èˆ‡ ${conversation.otherUserName} èŠå¤©</div>
              <div class="chat-thread-item">${conversation.productName}</div>
            </header>
            ${handoffButtonHTML}
            <div class="chat-messages" id="chatMessages">
              ${messages && messages.length > 0 ? messages.map(msg => {
                const isUser = String(msg.sender_id) === String(currentUserId);
                const msgDate = new Date(msg.sent_at);
                const timeStr = msgDate.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                return `
                  <div class="chat-message ${isUser ? 'chat-message-user' : 'chat-message-seller'}">
                    <div class="chat-bubble">${msg.content}</div>
                    <div class="chat-time">${timeStr}</div>
                  </div>
                `;
              }).join('') : '<div style="text-align: center; color: #6b7280; padding: 20px;">é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯ï¼Œé–‹å§‹å°è©±å§ï¼</div>'}
            </div>
            <form class="chat-input-area" id="chatInputForm">
              <input type="text" class="chat-input" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..." />
              <button type="submit" class="chat-send-btn">é€å‡º</button>
            </form>
          `;

          // Scroll to bottom
          const messagesArea = document.getElementById('chatMessages');
          if (messagesArea) {
            messagesArea.scrollTop = messagesArea.scrollHeight;
          }

          // Handle form submission
          const chatInputForm = document.getElementById('chatInputForm');
          const chatInput = document.getElementById('chatInput');
          if (chatInputForm && chatInput) {
            // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
            const newForm = chatInputForm.cloneNode(true);
            chatInputForm.parentNode.replaceChild(newForm, chatInputForm);
            
            const newInput = document.getElementById('chatInput');
            newForm.addEventListener('submit', async (e) => {
              e.preventDefault();
              const text = newInput.value.trim();
              if (!text) return;

              try {
                // ç™¼é€è¨Šæ¯
                await api.sendMessage({
                  request_id: conversation.requestId,
                  receiver_id: conversation.otherUserId,
                  content: text
                });

                // é‡æ–°è¼‰å…¥å°è©±
                await loadChatThread(conversation);
                await loadConversations(); // æ›´æ–°å°è©±åˆ—è¡¨
                newInput.value = '';
              } catch (error) {
                console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
                alert('ç™¼é€è¨Šæ¯å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
              }
            });
          }
        } catch (error) {
          console.error('è¼‰å…¥å°è©±å¤±æ•—:', error);
          chatThread.innerHTML = `<div class="chat-empty-state"><p>è¼‰å…¥å°è©±å¤±æ•—: ${error.message}</p></div>`;
        }
      }

      // Handle confirm handoff
      async function handleConfirmHandoff(requestId) {
        try {
          const result = await api.confirmHandoff(requestId);
          
          if (result.completed && result.both_confirmed) {
            // äº¤æ˜“å®Œæˆï¼Œé¡¯ç¤ºè©•åƒ¹é é¢
            if (result.transaction_id && result.needs_review) {
              await showReviewModal(result.transaction_id, result.buyer_id, result.seller_id);
            } else {
              alert('äº¤æ˜“å·²å®Œæˆï¼å·²è¨˜éŒ„åˆ°äº¤æ˜“ç´€éŒ„');
            }
            // é‡æ–°è¼‰å…¥å°è©±åˆ—è¡¨å’Œç•¶å‰å°è©±
            await loadConversations();
            // æ‰¾åˆ°å°æ‡‰çš„å°è©±ä¸¦é‡æ–°è¼‰å…¥
            const sentRequests = await api.getTradeRequests({ type: 'sent' });
            const receivedRequests = await api.getTradeRequests({ type: 'received' });
            const allRequests = [...sentRequests, ...receivedRequests];
            const request = allRequests.find(r => r.request_id === requestId);
            if (request) {
              const product = await api.getProduct(request.target_product_id);
              const isRequester = String(request.requester_id) === String(currentUserId);
              const otherUserId = isRequester
                ? request.owner_id
                : request.requester_id;
              const otherUserName = isRequester
                ? (request.owner_name || 'æœªçŸ¥ä½¿ç”¨è€…')
                : (request.requester_name || 'æœªçŸ¥ä½¿ç”¨è€…');
              const conversation = {
                requestId: requestId,
                productName: product.product_name,
                otherUserName: otherUserName,
                otherUserId: otherUserId
              };
              await loadChatThread(conversation);
            }
          } else {
            alert(result.message || 'å·²ç¢ºèªé¢äº¤ï¼Œç­‰å¾…å°æ–¹ç¢ºèª');
            // é‡æ–°è¼‰å…¥ç•¶å‰å°è©±ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const sentRequests = await api.getTradeRequests({ type: 'sent' });
            const receivedRequests = await api.getTradeRequests({ type: 'received' });
            const allRequests = [...sentRequests, ...receivedRequests];
            const request = allRequests.find(r => r.request_id === requestId);
            if (request) {
              const product = await api.getProduct(request.target_product_id);
              const isRequester = String(request.requester_id) === String(currentUserId);
              const otherUserId = isRequester
                ? request.owner_id
                : request.requester_id;
              const otherUserName = isRequester
                ? (request.owner_name || 'æœªçŸ¥ä½¿ç”¨è€…')
                : (request.requester_name || 'æœªçŸ¥ä½¿ç”¨è€…');
              const conversation = {
                requestId: requestId,
                productName: product.product_name,
                otherUserName: otherUserName,
                otherUserId: otherUserId
              };
              await loadChatThread(conversation);
            }
          }
        } catch (error) {
          console.error('ç¢ºèªé¢äº¤å¤±æ•—:', error);
          alert('ç¢ºèªé¢äº¤å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      }

      // Show review modal
      let currentReviewTransactionId = null;
      let currentReviewOtherUserId = null;
      
      async function showReviewModal(transactionId, buyerId, sellerId) {
        try {
          const isBuyer = String(currentUserId) === String(buyerId);
          const otherUserId = isBuyer ? sellerId : buyerId;
          
          currentReviewTransactionId = transactionId;
          currentReviewOtherUserId = otherUserId;
          
          // ç²å–è©•åƒ¹ç‹€æ…‹
          const reviewStatus = await api.getReviewStatus(transactionId);
          
          // ç²å–å°æ–¹è³‡è¨Š
          let otherUserName = 'å°æ–¹';
          try {
            const otherUser = await api.getUserById ? await api.getUserById(otherUserId) : null;
            if (otherUser && otherUser.user_name) {
              otherUserName = otherUser.user_name;
            }
          } catch (e) {
            console.warn('ç„¡æ³•ç²å–å°æ–¹è³‡è¨Š:', e);
          }
          
          // å‰µå»ºæˆ–æ›´æ–°æ¨¡æ…‹æ¡†
          let reviewModal = document.getElementById('reviewModal');
          if (!reviewModal) {
            reviewModal = document.createElement('div');
            reviewModal.id = 'reviewModal';
            reviewModal.className = 'modal-overlay';
            reviewModal.style.display = 'none';
            reviewModal.onclick = closeReviewModal;
            document.body.appendChild(reviewModal);
          }
          
          const reviewContent = document.getElementById('reviewContent');
          if (reviewStatus.user_reviewed) {
            // å·²è©•åƒ¹ï¼Œç­‰å¾…å°æ–¹è©•åƒ¹
            reviewContent.innerHTML = `
              <div style="text-align: center; padding: 20px;">
                <p style="color: #10b981; font-size: 18px; margin-bottom: 16px;">âœ“ æ‚¨å·²è©•åƒ¹</p>
                <p style="color: #6b7280;">ç­‰å¾… ${otherUserName} è©•åƒ¹å¾Œå³å¯å®Œæˆ</p>
                <button onclick="closeReviewModal()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">é—œé–‰</button>
              </div>
            `;
          } else {
            // é¡¯ç¤ºè©•åƒ¹è¡¨å–®
            reviewContent.innerHTML = `
              <p style="text-align: center; margin-bottom: 20px; color: #111827; font-weight: 500;">è«‹ç‚º ${otherUserName} è©•åƒ¹ï¼ˆå¯é¸ï¼‰</p>
              <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
                <button id="reviewLikeBtn" onclick="selectReviewRating(5)" style="padding: 16px 32px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <span style="font-size: 32px;">ğŸ‘</span>
                  <span>é»è®š</span>
                </button>
                <button id="reviewDislikeBtn" onclick="selectReviewRating(1)" style="padding: 16px 32px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                  <span style="font-size: 32px;">ğŸ‘</span>
                  <span>å€’è®š</span>
                </button>
              </div>
              <div class="form-group" style="margin-top: 20px;">
                <label for="reviewComment">è©•åƒ¹å…§å®¹ï¼ˆé¸å¡«ï¼‰ï¼š</label>
                <textarea id="reviewComment" rows="4" placeholder="åˆ†äº«æ‚¨çš„äº¤æ˜“é«”é©—..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
              </div>
              <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button onclick="submitReview()" id="submitReviewBtn" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">${selectedReviewRating ? 'æäº¤è©•åƒ¹' : 'ä¸åšè©•åƒ¹'}</button>
                <button onclick="skipReview()" style="padding: 12px 24px; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px; cursor: pointer;">ç¨å¾Œè©•åƒ¹</button>
              </div>
            `;
          }
          
          reviewModal.style.display = 'flex';
        } catch (error) {
          console.error('é¡¯ç¤ºè©•åƒ¹é é¢å¤±æ•—:', error);
          alert('é¡¯ç¤ºè©•åƒ¹é é¢å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      }
      
      let selectedReviewRating = null;
      
      function selectReviewRating(rating) {
        selectedReviewRating = rating;
        const likeBtn = document.getElementById('reviewLikeBtn');
        const dislikeBtn = document.getElementById('reviewDislikeBtn');
        const submitBtn = document.getElementById('submitReviewBtn');
        
        if (rating === 5) {
          likeBtn.style.background = '#d1fae5';
          likeBtn.style.borderColor = '#10b981';
          dislikeBtn.style.background = '#f3f4f6';
          dislikeBtn.style.borderColor = '#e5e7eb';
        } else {
          dislikeBtn.style.background = '#fee2e2';
          dislikeBtn.style.borderColor = '#dc2626';
          likeBtn.style.background = '#f3f4f6';
          likeBtn.style.borderColor = '#e5e7eb';
        }
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
        }
      }
      
      async function submitReview() {
        if (!currentReviewTransactionId || !currentReviewOtherUserId) {
          alert('ç¼ºå°‘å¿…è¦è³‡è¨Š');
          return;
        }
        
        try {
          const comment = document.getElementById('reviewComment')?.value.trim() || null;
          
          const reviewData = {
            transaction_id: currentReviewTransactionId,
            reviewee_id: currentReviewOtherUserId,
            rating: selectedReviewRating || null,  // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œå‚³ null è¡¨ç¤ºä¸åšè©•åƒ¹
            comment: comment
          };
          
          const result = await api.createReview(reviewData);
          
          // å¦‚æœé¸æ“‡ä¸åšè©•åƒ¹ï¼ˆskippedï¼‰ï¼Œç›´æ¥é—œé–‰
          if (result.skipped) {
            alert('å·²é¸æ“‡ä¸åšè©•åƒ¹');
            closeReviewModal();
            return;
          }
          
          // æª¢æŸ¥é›™æ–¹æ˜¯å¦éƒ½å·²è©•åƒ¹
          const reviewStatus = await api.getReviewStatus(currentReviewTransactionId);
          
          // é›™æ–¹éƒ½å·²å®Œæˆè©•åƒ¹æµç¨‹ï¼ˆè©•åƒ¹æˆ–é¸æ“‡ä¸åšè©•åƒ¹ï¼‰
          if (reviewStatus.both_reviewed) {
            alert('è©•åƒ¹æµç¨‹å®Œæˆï¼');
            closeReviewModal();
          } else {
            alert('è©•åƒ¹å·²æäº¤ï¼ç­‰å¾…å°æ–¹è©•åƒ¹ã€‚');
            // æ›´æ–°æ¨¡æ…‹æ¡†å…§å®¹
            await showReviewModal(currentReviewTransactionId, reviewStatus.buyer_id, reviewStatus.seller_id);
          }
        } catch (error) {
          console.error('æäº¤è©•åƒ¹å¤±æ•—:', error);
          alert('æäº¤è©•åƒ¹å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      }
      
      async function skipReview() {
        // ä¸åšè©•åƒ¹ï¼Œç›´æ¥é—œé–‰æ¨¡æ…‹æ¡†
        closeReviewModal();
      }
      
      function closeReviewModal() {
        const reviewModal = document.getElementById('reviewModal');
        if (reviewModal) {
          reviewModal.style.display = 'none';
        }
        selectedReviewRating = null;
        currentReviewTransactionId = null;
        currentReviewOtherUserId = null;
      }

      // Make functions global
      window.handleConfirmHandoff = handleConfirmHandoff;
      window.showReviewModal = showReviewModal;
      window.selectReviewRating = selectReviewRating;
      window.submitReview = submitReview;
      window.skipReview = skipReview;
      window.closeReviewModal = closeReviewModal;

      await loadConversations();
    });
  </script>
  
  <!-- Review Modal -->
  <div id="reviewModal" class="modal-overlay" style="display: none;" onclick="closeReviewModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h2>è©•åƒ¹äº¤æ˜“</h2>
        <button class="modal-close" onclick="closeReviewModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="reviewContent">
          <p style="text-align: center; color: #6b7280; padding: 20px;">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

