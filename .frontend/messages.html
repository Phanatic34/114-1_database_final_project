<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¨Šæ¯ - äºŒæ‰‹äº¤æ˜“å¹³å°</title>
  <link rel="stylesheet" href="ItemDetailPage.css?v=v1.0.0">
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background-color: #f5f5f5;
    }

    .messages-page {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px 40px;
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 24px;
      height: calc(100vh - 200px);
    }

    .conversations-list {
      background: white;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      overflow-y: auto;
    }

    .conversations-list h2 {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
    }

    .conversation-item {
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 8px;
      border: 2px solid transparent;
    }

    .conversation-item:hover {
      background: #f3f4f6;
    }

    .conversation-item.active {
      background: #eff6ff;
      border-color: #2563eb;
    }

    .conversation-header {
      display: flex;
      gap: 12px;
      align-items: start;
    }

    .conversation-image {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
      flex-shrink: 0;
    }

    .conversation-info {
      flex: 1;
      min-width: 0;
    }

    .conversation-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-user {
      font-size: 12px;
      color: #6b7280;
      margin: 0 0 4px 0;
    }

    .conversation-preview {
      font-size: 12px;
      color: #9ca3af;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .conversation-time {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .chat-panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-header-image {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      object-fit: cover;
      background: #f3f4f6;
    }

    .chat-header-info {
      flex: 1;
    }

    .chat-header-title {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }

    .chat-header-subtitle {
      font-size: 12px;
      color: #6b7280;
      margin: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: #f9fafb;
    }

    .message-bubble {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 12px;
      word-wrap: break-word;
    }

    .message-seller {
      background: white;
      border: 1px solid #e5e7eb;
      align-self: flex-start;
    }

    .message-user {
      background: #2563eb;
      color: white;
      align-self: flex-end;
      margin-left: auto;
    }

    .message-content {
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .message-time {
      font-size: 11px;
      opacity: 0.7;
    }

    .chat-input-area {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 12px;
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .chat-input-area button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background: #2563eb;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .chat-input-area button:hover {
      background: #1d4ed8;
    }

    .empty-chat {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #6b7280;
    }

    .empty-conversations {
      text-align: center;
      padding: 40px 20px;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .messages-page {
        grid-template-columns: 1fr;
        height: auto;
      }

      .conversations-list {
        max-height: 300px;
      }

      .chat-panel {
        min-height: 500px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="header-content">
      <a href="index.html" class="logo site-logo">
        <img src="logo.png" alt="äºŒæ‰‹äº¤æ˜“å¹³å° Logo" />
      </a>
      <nav class="header-nav">
        <a href="index.html">é¦–é </a>
        <a href="item_list.html">åˆ†é¡</a>
        <a href="sell.html">è³£æ±è¥¿</a>
        <a href="chat.html">èŠå¤©</a>
      </nav>
      <div class="header-actions">
        <!-- Will be populated by navbar.js -->
      </div>
    </div>
  </header>

  <main>
    <div class="messages-page">
      <!-- Conversations List -->
      <div class="conversations-list">
        <h2>å°è©±åˆ—è¡¨</h2>
        <div id="conversationsContainer">
          <!-- Conversations will be rendered here -->
        </div>
      </div>

      <!-- Chat Panel -->
      <div class="chat-panel" id="chatPanel">
        <div class="empty-chat" id="emptyChat">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ’¬</div>
          <div>é¸æ“‡ä¸€å€‹å°è©±é–‹å§‹èŠå¤©</div>
        </div>
      </div>
    </div>
  </main>

  <!-- Review Modal -->
  <div id="reviewModal" class="modal-overlay" style="display: none;" onclick="closeReviewModal()">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h2>è©•åƒ¹äº¤æ˜“</h2>
        <button class="modal-close" onclick="closeReviewModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="reviewContent">
          <p style="text-align: center; color: #6b7280; padding: 20px;">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="js/api.js?v=v1.0.0"></script>
  <script src="js/data.js?v=v1.0.0"></script>
  <script src="js/auth_check.js?v=v1.0.0"></script>
  <script src="js/images.js?v=v1.0.0"></script>
  <script src="js/navbar.js?v=v1.0.0"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const currentUser = getCurrentUser();

    // Get params for direct chat
    const urlParams = new URLSearchParams(window.location.search);
    const requestId = urlParams.get('requestId');
    const userId = urlParams.get('userId');

    // Render conversations (based on trade requests)
    async function renderConversations() {
      const container = document.getElementById('conversationsContainer');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">è¼‰å…¥ä¸­...</div>';
      
      try {
        // ç²å–æ‰€æœ‰äº¤æ˜“è«‹æ±‚ï¼ˆæˆ‘æå‡ºçš„å’Œæ”¶åˆ°çš„ï¼‰
        const sentRequests = await api.getTradeRequests({ type: 'sent' });
        const receivedRequests = await api.getTradeRequests({ type: 'received' });
        const allRequests = [...sentRequests, ...receivedRequests];
        
        // ä½¿ç”¨ Map å»é‡ï¼Œä»¥ request_id ç‚º key
        const uniqueRequestsMap = new Map();
        allRequests.forEach(request => {
          if (!uniqueRequestsMap.has(request.request_id)) {
            uniqueRequestsMap.set(request.request_id, request);
          }
        });
        const uniqueRequests = Array.from(uniqueRequestsMap.values());
        
        container.innerHTML = '';
        
        if (uniqueRequests.length === 0) {
          container.innerHTML = '<div class="empty-conversations">é‚„æ²’æœ‰ä»»ä½•å°è©±</div>';
        } else {
          // ç‚ºæ¯å€‹è«‹æ±‚å‰µå»ºå°è©±é …ç›®
          for (const request of uniqueRequests) {
            try {
              const product = await api.getProduct(request.target_product_id);
              const currentUserId = api.getUserId();
              // ç¢ºå®šå°æ–¹ IDï¼šå¦‚æœæˆ‘æ˜¯è«‹æ±‚è€…ï¼Œå°æ–¹æ˜¯æ“æœ‰è€…ï¼›å¦‚æœæˆ‘æ˜¯æ“æœ‰è€…ï¼Œå°æ–¹æ˜¯è«‹æ±‚è€…
              const isRequester = String(request.requester_id) === String(currentUserId);
              const otherUserId = isRequester
                ? (request.owner_id || null)
                : request.requester_id;
              
              // ç²å–æœ€å¾Œä¸€æ¢è¨Šæ¯
              let lastMessage = { content: 'é‚„æ²’æœ‰è¨Šæ¯', sent_at: request.created_at };
              try {
                const messages = await api.getMessages(request.request_id);
                if (messages && messages.length > 0) {
                  lastMessage = messages[messages.length - 1];
                }
              } catch (e) {
                console.log('ç²å–è¨Šæ¯å¤±æ•—:', e);
              }
              
              const item = document.createElement('div');
              item.className = 'conversation-item';
              item.dataset.requestId = request.request_id;
              item.dataset.userId = otherUserId;
              
              const time = new Date(lastMessage.sent_at || request.created_at);
              const timeStr = time.toLocaleString('zh-TW', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
              
              // ç¢ºå®šå°æ–¹åç¨±ï¼šå¦‚æœæˆ‘æ˜¯è«‹æ±‚è€…ï¼Œå°æ–¹æ˜¯æ“æœ‰è€…ï¼›å¦‚æœæˆ‘æ˜¯æ“æœ‰è€…ï¼Œå°æ–¹æ˜¯è«‹æ±‚è€…
              const otherUserName = String(request.requester_id) === String(currentUserId)
                ? (request.owner_name || 'æœªçŸ¥ä½¿ç”¨è€…')
                : (request.requester_name || 'æœªçŸ¥ä½¿ç”¨è€…');
              
              console.log('å°è©±é …ç›®:', { request, currentUserId, otherUserId, otherUserName });
              
              item.innerHTML = `
                <div class="conversation-header">
                  <img src="${getProductImageUrl(product)}" 
                       alt="${product.product_name || 'å•†å“'}" 
                       class="conversation-image">
                  <div class="conversation-info">
                    <div class="conversation-title">${product.product_name || 'å•†å“å·²ä¸‹æ¶'}</div>
                    <div class="conversation-user">${otherUserName}</div>
                    <div class="conversation-preview">${lastMessage.content || 'é‚„æ²’æœ‰è¨Šæ¯'}</div>
                    <div class="conversation-time">${timeStr}</div>
                  </div>
                </div>
              `;
              
              // Attach fallback to the image
              const img = item.querySelector('.conversation-image');
              if (img) attachImageFallback(img);
              
              item.addEventListener('click', () => {
                openChatByRequestId(request.request_id, otherUserId, product);
              });
              
              container.appendChild(item);
            } catch (error) {
              console.error('è¼‰å…¥å°è©±é …ç›®å¤±æ•—:', error);
            }
          }
        }
        
        // Auto-open chat if params provided
        if (requestId && userId) {
          openChatByRequestId(parseInt(requestId), parseInt(userId));
        }
      } catch (error) {
        console.error('è¼‰å…¥å°è©±åˆ—è¡¨å¤±æ•—:', error);
        container.innerHTML = `<div class="empty-conversations">è¼‰å…¥å¤±æ•—: ${error.message}</div>`;
      }
    }

    // Open chat by request ID
    async function openChatByRequestId(requestId, otherUserId = null, product = null) {
      try {
        const currentUserId = api.getUserId();
        
        // ç²å–è«‹æ±‚è³‡è¨Š
        const sentRequests = await api.getTradeRequests({ type: 'sent' });
        const receivedRequests = await api.getTradeRequests({ type: 'received' });
        const allRequests = [...sentRequests, ...receivedRequests];
        const request = allRequests.find(r => r.request_id === requestId);
        
        if (!request) {
          alert('æ‰¾ä¸åˆ°æ­¤è«‹æ±‚');
          return;
        }
        
        // ç¢ºå®šå°æ–¹è³‡è¨Š
        const isRequester = String(request.requester_id) === String(currentUserId);
        const actualOtherUserId = isRequester
          ? request.owner_id
          : request.requester_id;
        const otherUserName = isRequester
          ? (request.owner_name || 'æœªçŸ¥ä½¿ç”¨è€…')
          : (request.requester_name || 'æœªçŸ¥ä½¿ç”¨è€…');
        
        // ä½¿ç”¨å¯¦éš›çš„ otherUserIdï¼ˆå¦‚æœæä¾›äº†åƒæ•¸ä½†ä¸ç¬¦åˆï¼Œä½¿ç”¨å¯¦éš›çš„ï¼‰
        const finalOtherUserId = otherUserId && String(otherUserId) === String(actualOtherUserId)
          ? otherUserId
          : actualOtherUserId;
        
        // å¦‚æœæ²’æœ‰æä¾› productï¼Œå¾ API ç²å–
        if (!product) {
          product = await api.getProduct(request.target_product_id);
        }
        
        if (!product) {
          alert('ç„¡æ³•è¼‰å…¥å•†å“è³‡è¨Š');
          return;
        }
        
        console.log('é–‹å•Ÿå°è©±:', { requestId, currentUserId, finalOtherUserId, otherUserName, request, product });
        
        // Update active conversation
        document.querySelectorAll('.conversation-item').forEach(el => {
          el.classList.remove('active');
          if (el.dataset.requestId === String(requestId)) {
            el.classList.add('active');
          }
        });
        
        // Render chat panel
        const chatPanel = document.getElementById('chatPanel');
        
        // åˆ¤æ–·æ˜¯å¦é¡¯ç¤ºã€Œå·²é¢äº¤ã€æŒ‰éˆ•ï¼ˆåªæœ‰ç•¶è«‹æ±‚ç‹€æ…‹ç‚º Accepted æ™‚ï¼‰
        const canConfirmHandoff = request.status === 'Accepted';
        const isBuyer = isRequester;
        const buyerConfirmed = Boolean(request.buyer_confirmed_handoff);
        const sellerConfirmed = Boolean(request.seller_confirmed_handoff);
        const userConfirmed = isBuyer ? buyerConfirmed : sellerConfirmed;
        const bothConfirmed = buyerConfirmed && sellerConfirmed;
        const isCompleted = request.status === 'Completed' || bothConfirmed;
        
        console.log('å·²é¢äº¤æŒ‰éˆ•åˆ¤æ–·:', {
          requestId,
          status: request.status,
          canConfirmHandoff,
          isBuyer,
          buyerConfirmed,
          sellerConfirmed,
          userConfirmed,
          bothConfirmed,
          isCompleted
        });
        
        let handoffButtonHTML = '';
        if (canConfirmHandoff && !isCompleted) {
          const confirmStatus = [];
          if (buyerConfirmed) confirmStatus.push('è²·å®¶å·²ç¢ºèª');
          if (sellerConfirmed) confirmStatus.push('è³£å®¶å·²ç¢ºèª');
          
          handoffButtonHTML = `
            <div class="handoff-confirmation-section" style="padding: 16px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <span style="font-size: 14px; color: #6b7280;">
                  ${confirmStatus.length > 0 ? confirmStatus.join('ã€') : 'ç­‰å¾…ç¢ºèªé¢äº¤'}
                </span>
                <button 
                  id="confirmHandoffBtn" 
                  onclick="handleConfirmHandoff(${requestId})"
                  ${userConfirmed ? 'disabled' : ''}
                  style="padding: 8px 16px; background: ${userConfirmed ? '#9ca3af' : '#3b82f6'}; color: white; border: none; border-radius: 8px; cursor: ${userConfirmed ? 'not-allowed' : 'pointer'}; font-size: 14px; font-weight: 500;"
                >
                  ${userConfirmed ? 'âœ“ å·²ç¢ºèªé¢äº¤' : 'ç¢ºèªå·²é¢äº¤'}
                </button>
              </div>
            </div>
          `;
        } else if (isCompleted) {
          handoffButtonHTML = `
            <div class="handoff-confirmation-section" style="padding: 16px; background: #d1fae5; border-bottom: 1px solid #10b981;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 16px;">âœ“</span>
                <span style="font-size: 14px; color: #065f46; font-weight: 500;">äº¤æ˜“å·²å®Œæˆ</span>
              </div>
            </div>
          `;
        }
        
        chatPanel.innerHTML = `
          <div class="chat-header">
            <img src="${getProductImageUrl(product)}" 
                 alt="${product.product_name}" 
                 class="chat-header-image">
            <div class="chat-header-info">
            <h3 class="chat-header-title">èˆ‡ ${otherUserName} èŠå¤©</h3>
            <p class="chat-header-subtitle">${product.product_name}</p>
          </div>
        </div>
        ${handoffButtonHTML}
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
          <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯...">
          <button onclick="sendMessageByRequestId(${requestId}, ${finalOtherUserId})">é€å‡º</button>
        </div>
      `;
      
      // Load messages
      await loadMessagesByRequestId(requestId);
      
      // Focus input
      setTimeout(() => {
        const input = document.getElementById('messageInput');
        if (input) {
          input.focus();
          input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              sendMessageByRequestId(requestId, finalOtherUserId);
            }
          });
        }
      }, 100);
      } catch (error) {
        console.error('é–‹å•Ÿå°è©±å¤±æ•—:', error);
        alert('é–‹å•Ÿå°è©±å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }

    // Load messages by request ID
    async function loadMessagesByRequestId(requestId) {
      try {
        const messages = await api.getMessages(requestId);
        const container = document.getElementById('chatMessages');
        const currentUserId = api.getUserId();
        
        container.innerHTML = '';
        
        if (!messages || messages.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯ï¼Œé–‹å§‹å°è©±å§ï¼</div>';
        } else {
          messages.forEach(msg => {
            const isSender = String(msg.sender_id) === String(currentUserId);
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isSender ? 'message-user' : 'message-seller'}`;
            
            const time = new Date(msg.sent_at);
            const timeStr = time.toLocaleString('zh-TW', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
            
            bubble.innerHTML = `
              <div class="message-content">${msg.content}</div>
              <div class="message-time">${timeStr}</div>
            `;
            container.appendChild(bubble);
          });
        }
        
        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      } catch (error) {
        console.error('è¼‰å…¥è¨Šæ¯å¤±æ•—:', error);
        const container = document.getElementById('chatMessages');
        container.innerHTML = `<div style="text-align: center; color: #dc2626; padding: 20px;">è¼‰å…¥è¨Šæ¯å¤±æ•—: ${error.message}</div>`;
      }
    }

    // Send message by request ID
    async function sendMessageByRequestId(requestId, receiverId) {
      const input = document.getElementById('messageInput');
      const text = input.value.trim();
      
      if (!text) return;
      
      try {
        await api.sendMessage({
          request_id: requestId,
          receiver_id: receiverId,
          content: text
        });
        
        // Reload messages and conversations
        await loadMessagesByRequestId(requestId);
        await renderConversations();
        
        // Clear input
        input.value = '';
      } catch (error) {
        console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
        alert('ç™¼é€è¨Šæ¯å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }

    // Handle confirm handoff
    async function handleConfirmHandoff(requestId) {
      try {
        const result = await api.confirmHandoff(requestId);
        
        if (result.completed && result.both_confirmed) {
          // äº¤æ˜“å®Œæˆï¼Œé¡¯ç¤ºè©•åƒ¹é é¢
          if (result.transaction_id && result.needs_review) {
            await showReviewModal(result.transaction_id, result.buyer_id, result.seller_id);
          } else {
            alert('äº¤æ˜“å·²å®Œæˆï¼å·²è¨˜éŒ„åˆ°äº¤æ˜“ç´€éŒ„');
          }
          // é‡æ–°è¼‰å…¥å°è©±ä»¥æ›´æ–°ç‹€æ…‹
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('userId');
          await openChatByRequestId(requestId, userId ? parseInt(userId) : null);
          await renderConversations();
        } else {
          alert(result.message || 'å·²ç¢ºèªé¢äº¤ï¼Œç­‰å¾…å°æ–¹ç¢ºèª');
          // é‡æ–°è¼‰å…¥å°è©±ä»¥æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
          const urlParams = new URLSearchParams(window.location.search);
          const userId = urlParams.get('userId');
          await openChatByRequestId(requestId, userId ? parseInt(userId) : null);
        }
      } catch (error) {
        console.error('ç¢ºèªé¢äº¤å¤±æ•—:', error);
        alert('ç¢ºèªé¢äº¤å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }

    // Show review modal
    let currentReviewTransactionId = null;
    let currentReviewOtherUserId = null;
    
    async function showReviewModal(transactionId, buyerId, sellerId) {
      try {
        const currentUserId = api.getUserId();
        const isBuyer = String(currentUserId) === String(buyerId);
        const otherUserId = isBuyer ? sellerId : buyerId;
        
        currentReviewTransactionId = transactionId;
        currentReviewOtherUserId = otherUserId;
        
        // ç²å–è©•åƒ¹ç‹€æ…‹
        const reviewStatus = await api.getReviewStatus(transactionId);
        
        // ç²å–å°æ–¹è³‡è¨Š
        let otherUserName = 'å°æ–¹';
        try {
          const otherUser = await api.getUserById ? await api.getUserById(otherUserId) : null;
          if (otherUser && otherUser.user_name) {
            otherUserName = otherUser.user_name;
          }
        } catch (e) {
          console.warn('ç„¡æ³•ç²å–å°æ–¹è³‡è¨Š:', e);
        }
        
        const reviewContent = document.getElementById('reviewContent');
        if (reviewStatus.user_reviewed) {
          // å·²è©•åƒ¹ï¼Œç­‰å¾…å°æ–¹è©•åƒ¹
          reviewContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #10b981; font-size: 18px; margin-bottom: 16px;">âœ“ æ‚¨å·²è©•åƒ¹</p>
              <p style="color: #6b7280;">ç­‰å¾… ${otherUserName} è©•åƒ¹å¾Œå³å¯å®Œæˆ</p>
              <button onclick="closeReviewModal()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">é—œé–‰</button>
            </div>
          `;
        } else {
          // é¡¯ç¤ºè©•åƒ¹è¡¨å–®
          reviewContent.innerHTML = `
            <p style="text-align: center; margin-bottom: 20px; color: #111827; font-weight: 500;">è«‹ç‚º ${otherUserName} è©•åƒ¹ï¼ˆå¯é¸ï¼‰</p>
            <div style="display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;">
              <button id="reviewLikeBtn" onclick="selectReviewRating(5)" style="padding: 16px 32px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                <span style="font-size: 32px;">ğŸ‘</span>
                <span>é»è®š</span>
              </button>
              <button id="reviewDislikeBtn" onclick="selectReviewRating(1)" style="padding: 16px 32px; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; font-size: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                <span style="font-size: 32px;">ğŸ‘</span>
                <span>å€’è®š</span>
              </button>
            </div>
            <div class="form-group" style="margin-top: 20px;">
              <label for="reviewComment">è©•åƒ¹å…§å®¹ï¼ˆé¸å¡«ï¼‰ï¼š</label>
              <textarea id="reviewComment" rows="4" placeholder="åˆ†äº«æ‚¨çš„äº¤æ˜“é«”é©—..." style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button onclick="submitReview()" id="submitReviewBtn" style="flex: 1; padding: 12px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">${selectedReviewRating ? 'æäº¤è©•åƒ¹' : 'ä¸åšè©•åƒ¹'}</button>
              <button onclick="skipReview()" style="padding: 12px 24px; background: #f3f4f6; color: #6b7280; border: none; border-radius: 8px; cursor: pointer;">ç¨å¾Œè©•åƒ¹</button>
            </div>
          `;
        }
        
        document.getElementById('reviewModal').style.display = 'flex';
      } catch (error) {
        console.error('é¡¯ç¤ºè©•åƒ¹é é¢å¤±æ•—:', error);
        alert('é¡¯ç¤ºè©•åƒ¹é é¢å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }
    
    let selectedReviewRating = null;
    
    function selectReviewRating(rating) {
      selectedReviewRating = rating;
      const likeBtn = document.getElementById('reviewLikeBtn');
      const dislikeBtn = document.getElementById('reviewDislikeBtn');
      const submitBtn = document.getElementById('submitReviewBtn');
      
      if (rating === 5) {
        likeBtn.style.background = '#d1fae5';
        likeBtn.style.borderColor = '#10b981';
        dislikeBtn.style.background = '#f3f4f6';
        dislikeBtn.style.borderColor = '#e5e7eb';
      } else {
        dislikeBtn.style.background = '#fee2e2';
        dislikeBtn.style.borderColor = '#dc2626';
        likeBtn.style.background = '#f3f4f6';
        likeBtn.style.borderColor = '#e5e7eb';
      }
      
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
      }
    }
    
    async function submitReview() {
      if (!currentReviewTransactionId || !currentReviewOtherUserId) {
        alert('ç¼ºå°‘å¿…è¦è³‡è¨Š');
        return;
      }
      
      try {
        const comment = document.getElementById('reviewComment')?.value.trim() || null;
        
        const reviewData = {
          transaction_id: currentReviewTransactionId,
          reviewee_id: currentReviewOtherUserId,
          rating: selectedReviewRating || null,  // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œå‚³ null è¡¨ç¤ºä¸åšè©•åƒ¹
          comment: comment
        };
        
        const result = await api.createReview(reviewData);
        
        // å¦‚æœé¸æ“‡ä¸åšè©•åƒ¹ï¼ˆskippedï¼‰ï¼Œç›´æ¥é—œé–‰
        if (result.skipped) {
          alert('å·²é¸æ“‡ä¸åšè©•åƒ¹');
          closeReviewModal();
          return;
        }
        
        // æª¢æŸ¥é›™æ–¹æ˜¯å¦éƒ½å·²è©•åƒ¹æˆ–é¸æ“‡ä¸åšè©•åƒ¹
        const reviewStatus = await api.getReviewStatus(currentReviewTransactionId);
        
        // é›™æ–¹éƒ½å·²å®Œæˆè©•åƒ¹æµç¨‹ï¼ˆè©•åƒ¹æˆ–é¸æ“‡ä¸åšè©•åƒ¹ï¼‰
        if (reviewStatus.both_reviewed || (reviewStatus.buyer_reviewed && reviewStatus.seller_reviewed)) {
          alert('è©•åƒ¹æµç¨‹å®Œæˆï¼');
          closeReviewModal();
        } else {
          alert('è©•åƒ¹å·²æäº¤ï¼ç­‰å¾…å°æ–¹è©•åƒ¹ã€‚');
          // æ›´æ–°æ¨¡æ…‹æ¡†å…§å®¹
          await showReviewModal(currentReviewTransactionId, reviewStatus.buyer_id, reviewStatus.seller_id);
        }
      } catch (error) {
        console.error('æäº¤è©•åƒ¹å¤±æ•—:', error);
        alert('æäº¤è©•åƒ¹å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'));
      }
    }
    
    async function skipReview() {
      // ä¸åšè©•åƒ¹ï¼Œç›´æ¥é—œé–‰æ¨¡æ…‹æ¡†
      closeReviewModal();
    }
    
    function closeReviewModal() {
      document.getElementById('reviewModal').style.display = 'none';
      selectedReviewRating = null;
      currentReviewTransactionId = null;
      currentReviewOtherUserId = null;
    }

    // Make functions global
    window.openChatByRequestId = openChatByRequestId;
    window.sendMessageByRequestId = sendMessageByRequestId;
    window.handleConfirmHandoff = handleConfirmHandoff;
    window.showReviewModal = showReviewModal;
    window.selectReviewRating = selectReviewRating;
    window.submitReview = submitReview;
    window.skipReview = skipReview;
    window.closeReviewModal = closeReviewModal;

      // Initial render
      renderConversations();
    });
  </script>
</body>
</html>

