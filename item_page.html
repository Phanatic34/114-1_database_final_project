<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>商品詳情 - 二手交易平台</title>
  <link rel="stylesheet" href="ItemDetailPage.css">
  <style>
    /* Additional styles for standalone HTML version */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    }
    
    .standalone-note {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      margin: 1rem;
      border-radius: 8px;
      text-align: center;
    }

    /* Message button styling */
    .btn-message {
      padding: 0.875rem 1.5rem;
      border: 2px solid var(--primary-blue);
      border-radius: var(--border-radius);
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      background: white;
      color: var(--primary-blue);
      width: 100%;
      margin-bottom: 0.5rem;
    }

    .btn-message:hover {
      background: var(--accent-blue);
    }

    /* Chat modal specific styles */
    .chat-header-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .chat-header-info .seller-avatar {
      width: 40px;
      height: 40px;
      font-size: 1.2rem;
    }

    .chat-header-info h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .chat-body {
      display: flex;
      flex-direction: column;
      height: 500px;
      padding: 0;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message-bubble {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      word-wrap: break-word;
    }

    .message-seller {
      align-self: flex-start;
      background: white;
      border: 1px solid var(--border-color);
    }

    .message-user {
      align-self: flex-end;
      background: var(--primary-blue);
      color: white;
    }

    .message-content {
      margin-bottom: 0.25rem;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .chat-input-area {
      display: flex;
      gap: 0.5rem;
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      background: white;
    }

    .chat-input-area input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 0.95rem;
      font-family: inherit;
    }

    .chat-input-area input:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 3px var(--accent-blue);
    }

    .chat-input-area button {
      padding: 0.75rem 1.5rem;
      white-space: nowrap;
    }

    /* Header search input */
    .header-search {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-search input {
      padding: 8px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      width: 200px;
      transition: all 0.2s;
    }

    .header-search input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    .header-search input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .header-search button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .header-search button:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    @media (max-width: 768px) {
      .header-search {
        display: none;
      }
    }

    /* Main content and breadcrumb adjustments */
    .main-content {
      padding: 0;
    }

    .breadcrumb {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 16px 0;
    }

    /* Main layout container */
    .item-page-main {
      max-width: 1200px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }

    /* Upper section: image + main info + purchase card */
    .item-top-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.3fr) 320px;
      column-gap: 32px;
      align-items: flex-start;
    }

    .item-col-center {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0;
    }

    /* Lower section: 商品資訊 + 商品描述 */
    .item-detail-row {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.15fr);
      column-gap: 24px;
      margin-top: 24px;
      padding-top: 18px;
      border-top: 1px solid #e5e7eb;
    }

    /* Left Column - Image Gallery + 商品資訊 */
    .item-image-main {
      background: #f3f4f6;
      border-radius: 16px;
      padding: 16px;
      min-height: 320px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .item-image-main .main-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
    }

    .item-image-main .image-badge {
      position: absolute;
      top: 24px;
      right: 24px;
      background: #2563eb;
      color: white;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
    }

    .item-thumbnails {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .item-thumbnails .thumbnail {
      flex: 1;
      min-width: 0;
      border: 2px solid transparent;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      background: #f3f4f6;
      padding: 0;
    }

    .item-thumbnails .thumbnail.active {
      border-color: #2563eb;
    }

    .item-thumbnails .thumbnail img {
      width: 100%;
      height: auto;
      display: block;
    }

    .item-info-card {
      padding: 16px 20px;
      border-radius: 16px;
      background: #f5f5f5;
    }

    /* Remove border/margin/padding from section-divider for these two sections */
    .item-info-card,
    .item-description-section {
      border-top: none;
      margin-top: 0;
      padding-top: 0;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #111827;
    }

    .item-info-list {
      margin: 0;
      padding: 0;
    }

    .item-info-row {
      display: flex;
      padding: 4px 0;
      font-size: 14px;
    }

    .item-info-row dt {
      width: 80px;
      color: #6b7280;
      flex-shrink: 0;
    }

    .item-info-row dd {
      margin: 0;
      color: #111827;
      flex: 1;
    }

    .item-info-tags dd {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag-pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #e0edff;
      color: #2563eb;
      font-size: 13px;
    }

    /* Listing Header - spans center + right visually */
    .listing-header {
      display: flex;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 16px;
      position: relative;
    }

    /* On larger screens, make header span visually by extending into right column space */
    @media (min-width: 961px) {
      .listing-header {
        margin-right: -320px; /* Negative margin to extend into right column */
        padding-right: 320px; /* Padding to maintain content spacing */
      }
      .listing-header-right {
        display: none; /* Availability text is now in item-title-row */
      }
    }

    .listing-header-left {
      flex: 2;
    }

    .listing-header-right {
      flex: 1;
      text-align: right;
      font-size: 13px;
      color: #6b7280;
    }

    .listing-mode-summary {
      white-space: nowrap;
    }


    /* Center Column - Title, Seller, Trade Modes, Rules, Description */
    /* Item header container */
    .item-header {
      display: flex;
      flex-direction: column;
    }

    /* Title row: title + availability */
    .item-title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      padding-bottom: 10px;
      margin-bottom: 16px;
      border-bottom: 1px solid #e5e7eb; /* subtle divider */
    }

    .item-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      color: #111827;
      line-height: 1.3;
      flex: 1;
    }

    .item-availability {
      font-size: 13px;
      color: #6b7280;
      white-space: nowrap;
      margin-top: 4px;
    }

    /* Seller row */
    .item-seller-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .seller-inline {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 0;
    }

    .seller-avatar-small {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e0edff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #2563eb;
      flex-shrink: 0;
    }

    .seller-text-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .seller-main-line {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }

    .seller-sub-line {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: #6b7280;
    }

    .seller-rating-text {
      white-space: nowrap;
    }

    .seller-dot {
      color: #9ca3af;
    }

    .seller-link-button {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 13px;
      color: #2563eb;
      cursor: pointer;
      text-decoration: underline;
      white-space: nowrap;
    }

    .seller-link-button:hover {
      color: #1d4ed8;
    }

    .trade-mode-badges {
      display: flex;
      flex-wrap: nowrap;       /* keep them on one line */
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    /* On very small screens, allow wrapping so it doesn't overflow */
    @media (max-width: 480px) {
      .trade-mode-badges {
        flex-wrap: wrap;
      }
    }

    .trade-mode-badges .badge,
    .mode-pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
    }

    /* Default pill style (soft blue fill) */
    .trade-mode-badges .badge,
    .mode-pill {
      background: #e5f0ff;        /* light blue fill */
      border: 1px solid #bfdbfe;  /* soft blue border */
      color: #1d4ed8;             /* darker blue text */
    }

    /* Mode-specific colors */
    .mode-sale,
    .trade-mode-badges .badge.mode-sale {
      background: #e0f2fe;
      border-color: #bae6fd;
      color: #1d4ed8;
    }

    .mode-trade,
    .trade-mode-badges .badge.mode-trade {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #15803d;
    }

    .mode-wish,
    .trade-mode-badges .badge.mode-wish {
      background: #fef3c7;
      border-color: #fde68a;
      color: #92400e;
    }

    .trade-rule-card {
      background: #e5f0ff;
      border-radius: 16px;
      padding: 16px 20px;
      border-left: 4px solid #2563eb;
      margin-top: 12px;
      margin-bottom: 24px;
    }

    /* Reusable section divider helper class */
    .section-divider {
      margin-top: 18px;
      padding-top: 18px;
      border-top: 1px solid #e5e7eb; /* thin, light grey line */
    }


    .trade-rule-card h2 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #2563eb;
    }

    .trade-rule-card p {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.6;
      color: #111827;
    }

    .item-description-section {
      margin-bottom: 24px;
    }

    .item-description-section .section-title {
      margin-bottom: 12px;
    }

    .item-description-section p,
    .item-description-section li {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .item-description-section ul {
      margin: 8px 0;
      padding-left: 24px;
    }

    .view-stats {
      margin-top: 12px;
      font-size: 13px;
      color: #6b7280;
    }

    /* Right Column - Sticky Action Card */
    .item-col-right {
      position: sticky;
      top: 100px;
    }

    .action-card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      padding: 20px 20px 16px;
      position: relative; /* positioning context for dropdown */
    }

    /* Header row: label on the left, dots on the right */
    .purchase-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    /* Three-dot button */
    .purchase-more-btn {
      border: none;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      color: #9ca3af; /* neutral gray */
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 999px;
      transition: background 0.2s;
    }

    .purchase-more-btn:hover {
      background: #e5e7eb;
    }

    /* Dropdown menu container */
    .purchase-more-menu {
      position: absolute;
      top: 16px;       /* align with top padding inside card */
      right: 16px;     /* stick to top-right corner of the card */
      min-width: 140px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.18);
      padding: 6px 0;
      z-index: 20;
    }

    /* Menu item: 檢舉商品 */
    .purchase-more-menu-item {
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
      color: #111827;
      cursor: pointer;
      transition: background 0.2s;
    }

    .purchase-more-menu-item:hover {
      background: #f3f4f6;
    }

    .action-price-block {
      margin-bottom: 12px;
    }

    .action-price-label {
      font-size: 13px;
      color: #6b7280;
      display: block;
      margin-bottom: 4px;
    }

    .action-price {
      font-size: 22px;
      font-weight: 700;
      color: #2563eb;
    }

    .action-quantity {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }

    .action-quantity label {
      color: #374151;
    }

    .action-quantity select {
      padding: 6px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .action-buttons button {
      width: 100%;
    }

    /* separators only between primary buttons */
    .action-buttons .btn-primary + .btn-primary {
      margin-top: 6px;
      position: relative;
    }

    .action-buttons .btn-primary + .btn-primary::before {
      content: "";
      position: absolute;
      top: -4px;
      left: 16px;
      right: 16px;
      height: 1px;
      background: #e5e7eb; /* subtle grey line between primary buttons */
    }

    /* remove separator before outline button */
    .action-buttons .btn-outline {
      margin-top: 10px; /* space after the last blue button */
    }

    .btn-primary {
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-outline {
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #2563eb;
      background: #ffffff;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .btn-outline:hover {
      background: #eff6ff;
    }



    .pickup-section h4 {
      font-size: 14px;
      margin: 0 0 4px 0;
      color: #111827;
      font-weight: 600;
    }

    .pickup-section p {
      font-size: 14px;
      color: #374151;
      margin: 0;
    }

    /* Responsive behavior */
    @media (max-width: 960px) {
      .item-top-grid {
        grid-template-columns: minmax(280px, 1.4fr) minmax(280px, 1.6fr);
      }
      .item-col-right {
        position: static;
        grid-column: 1 / -1;
        margin-top: 24px;
      }
      .item-detail-row {
        grid-template-columns: 1fr;
      }
      .listing-header {
        margin-right: 0;
        padding-right: 0;
      }
      .listing-header-right {
        display: none; /* Hide header price on tablet, show in action card */
      }
    }

    @media (max-width: 640px) {
      .item-top-grid {
        grid-template-columns: 1fr;
      }
      .item-col-left,
      .item-col-center,
      .item-col-right {
        grid-column: 1 / -1;
      }
      .item-detail-row {
        grid-template-columns: 1fr;
      }
      .item-title-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      .item-availability {
        margin-top: 0;
      }
      .seller-inline {
        flex-direction: column;
        align-items: flex-start;
      }
      .listing-header {
        flex-direction: column;
        gap: 12px;
      }
      .listing-header-right {
        display: none; /* Availability text is now in item-title-row */
      }
    }
  </style>
</head>
<body>
  <div class="standalone-note">
    <strong>注意：</strong>這是獨立 HTML 版本，用於快速預覽。完整功能請使用 React 版本 (ItemDetailPage.tsx)
  </div>

  <!-- Header -->
  <header class="site-header">
    <div class="header-content">
      <div class="logo">二手交易平台</div>
      <nav class="header-nav">
        <a href="index.html">首頁</a>
        <a href="item_list.html">分類</a>
        <a href="sell.html">賣東西</a>
      </nav>
      <div class="header-actions">
        <div class="header-search">
          <input type="text" id="headerSearchInput" placeholder="搜尋商品…">
          <button onclick="handleHeaderSearch()">搜尋</button>
        </div>
        <!-- Cart and profile icons will be populated by navbar.js -->
      </div>
    </div>
  </header>

  <main class="main-content">
    <div class="breadcrumb">
      <a href="index.html">首頁</a> / <a href="item_list.html" id="breadcrumbCategory">分類</a> / <span id="breadcrumbSubcategory">商品詳情</span>
    </div>

    <div class="item-page-main">
      <!-- UPPER SECTION: image + main info + purchase card -->
      <div class="item-top-grid">
        <!-- Left Column - Image Gallery -->
        <div class="item-col-left">
          <div class="item-image-main">
            <img
              id="main-image"
              src=""
              alt=""
              class="main-image"
            />
            <div class="image-badge" id="conditionBadge">九成新</div>
          </div>

          <div class="item-thumbnails">
            <button class="thumbnail active" onclick="changeImage(0)">
              <img src="https://via.placeholder.com/150/0064D2/FFFFFF?text=1" alt="View 1" />
            </button>
            <button class="thumbnail" onclick="changeImage(1)">
              <img src="https://via.placeholder.com/150/0052A3/FFFFFF?text=2" alt="View 2" />
            </button>
            <button class="thumbnail" onclick="changeImage(2)">
              <img src="https://via.placeholder.com/150/003D7A/FFFFFF?text=3" alt="View 3" />
            </button>
            <button class="thumbnail" onclick="changeImage(3)">
              <img src="https://via.placeholder.com/150/002855/FFFFFF?text=4" alt="View 4" />
            </button>
          </div>
        </div>

        <!-- Center Column - Listing Header + Trade Rules -->
        <div class="item-col-center">
          <a href="item_list.html" class="back-link" style="display: inline-block; margin-bottom: 12px; color: #2563eb; text-decoration: none; font-size: 14px;">← 返回商品列表</a>
          
          <!-- Listing Header spans center + right visually -->
          <div class="listing-header">
            <div class="listing-header-left">
              <div class="item-header">
                <div class="item-title-row">
              <h1 class="item-title" id="itemTitle">Nintendo Switch OLED 白色主機 九成新</h1>
                  <div id="listingModeSummary" class="item-availability"></div>
                </div>

                <div class="item-seller-row">
              <div class="seller-inline">
                <div class="seller-avatar-small" id="sellerAvatar">
                  <span>G</span>
                </div>
                <div class="seller-text-block">
                  <div class="seller-main-line">
                    <span id="sellerName" class="seller-name">game_lover_2024</span>
                    <span id="sellerCount" class="seller-count">(127)</span>
                  </div>
                  <div class="seller-sub-line">
                    <span id="sellerRatingText" class="seller-rating-text">99.9% 好評</span>
                    <span class="seller-dot">·</span>
                    <button class="seller-link-button" id="sellerViewItemsButton">
                      查看賣家其他商品
                    </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="trade-mode-badges" id="tradeModeBadges">
                <!-- Badges will be populated by JS -->
              </div>

            </div>

            <div class="listing-header-right">
              <!-- Availability text moved to item-title-row above -->
            </div>
          </div>

          <section class="trade-rule-card" id="tradeRuleCard">
            <h2>交換規則</h2>
            <div id="tradeRuleBody">
              <!-- Content will be populated by JS -->
            </div>
          </section>
        </div>

        <!-- Right Column - Purchase Card -->
        <aside class="item-col-right">
          <div class="action-card">
            <div class="action-price-block">
              <div id="actionPriceBlock">
                <div class="purchase-card-header">
                  <span class="action-price-label">價格</span>
                  <!-- three-dot button -->
                  <button
                    id="purchaseMoreBtn"
                    class="purchase-more-btn"
                    type="button"
                    aria-label="更多選項"
                  >
                    ⋮
                  </button>
                  <!-- dropdown menu -->
                  <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                    <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                      檢舉商品
                    </button>
                  </div>
                </div>
                <div class="action-price" id="actionPrice">NT$ 8,500</div>
              </div>
            </div>

            <div class="action-quantity">
              <label for="qty">數量：</label>
              <select id="qty" onchange="updateTotal()">
                <option value="1">1</option>
              </select>
            </div>

            <div class="action-buttons">
              <button id="btnBuyNow" class="btn-primary" onclick="handlePurchase()">立即購買</button>
              <button id="btnTrade" class="btn-primary" onclick="handleTrade()">以物易物</button>
              <button id="btnAddToCart" class="btn-primary" onclick="handleAddToCart()">加入購物車</button>
              <button id="messageButtonMain" class="btn-outline" onclick="handleOpenChat()">聯絡賣家</button>
            </div>

            <div class="pickup-section section-divider">
              <h4>取貨方式：</h4>
              <p id="pickupInfo">面交 | 台北市信義區 | 時間可議</p>
            </div>
          </div>
        </aside>
      </div>

      <!-- LOWER SECTION: 商品資訊 + 商品描述 -->
        <div class="item-detail-row">
          <section class="item-info-card">
            <h3 class="section-title">商品資訊</h3>
            <dl class="item-info-list">
              <div class="item-info-row">
                <dt>商品狀況：</dt>
                <dd id="itemCondition">九成新</dd>
              </div>
              <div class="item-info-row">
                <dt>所在地：</dt>
                <dd id="itemLocation">台北市信義區</dd>
              </div>
              <div class="item-info-row">
                <dt>庫存數量：</dt>
                <dd>1 件</dd>
              </div>
              <div class="item-info-row item-info-tags">
                <dt>標籤：</dt>
                <dd id="itemTags">
                  <!-- Tags will be populated by JS -->
                </dd>
              </div>
            </dl>
          </section>

          <section class="item-description-section">
            <h3 class="section-title">商品描述</h3>
            <div class="description-content" id="itemDescription">
              <!-- Content will be populated by JS -->
            </div>
            <p class="view-stats" id="viewStats">瀏覽次數：342　追蹤人數：8</p>
          </section>
      </div>
    </div>
  </main>

  <!-- Trade Modal -->
  <div id="trade-modal" class="modal-overlay" style="display: none;" onclick="closeTradeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>提出交換提案</h2>
        <button class="modal-close" onclick="closeTradeModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="trade-requirement">
          <strong>賣家需求：</strong>
          <p id="tradeRequirementText">想換 PlayStation 5 或 Xbox Series X，也接受其他 Nintendo 主機相關商品</p>
        </div>
        <div class="user-items-list">
          <h3>選擇你的物品（僅可選擇一項）：</h3>
          <div class="items-grid">
            <div class="trade-item-card item-card" data-item-id="ps5" onclick="selectTradeItem(this)">
              <img src="https://via.placeholder.com/150/0064D2/FFFFFF?text=PS5" alt="PlayStation 5" />
              <div class="item-card-title">PlayStation 5 光碟版</div>
            </div>
            <div class="trade-item-card item-card" data-item-id="xbox-series-x" onclick="selectTradeItem(this)">
              <img src="https://via.placeholder.com/150/0052A3/FFFFFF?text=Xbox" alt="Xbox Series X" />
              <div class="item-card-title">Xbox Series X</div>
            </div>
          </div>
        </div>
        <div class="trade-message">
          <label for="trade-message">給賣家的訊息（選填）：</label>
          <textarea id="trade-message" placeholder="例如：希望可以當面交換，時間地點可議..." rows="4"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeTradeModal()">取消</button>
        <button id="submitTradeBtn" class="btn-primary" onclick="handleSubmitTrade()" disabled>送出交換提案</button>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chat-modal" class="modal-overlay" style="display: none;" onclick="closeChatModal()">
    <div class="modal-content chat-modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="chat-header-info">
          <div class="seller-avatar" id="chatSellerAvatar">G</div>
          <h2 id="chatSellerName">game_lover_2024</h2>
        </div>
        <button class="modal-close" onclick="closeChatModal()">×</button>
      </div>
      <div class="modal-body chat-body">
        <div class="messages-area" id="messages-area">
          <div class="message-bubble message-seller">
            <div class="message-content">你好！對這個商品有興趣嗎？</div>
            <div class="message-time">昨天 14:30</div>
          </div>
          <div class="message-bubble message-user">
            <div class="message-content">你好，我想了解一下商品狀況</div>
            <div class="message-time">昨天 15:20</div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chat-message" placeholder="輸入訊息..." />
          <button class="btn-primary" onclick="handleSendMessage()">送出訊息</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Image gallery
    const images = [
      'https://via.placeholder.com/600x600/0064D2/FFFFFF?text=Nintendo+Switch+1',
      'https://via.placeholder.com/600x600/0052A3/FFFFFF?text=Nintendo+Switch+2',
      'https://via.placeholder.com/600x600/003D7A/FFFFFF?text=Nintendo+Switch+3',
      'https://via.placeholder.com/600x600/002855/FFFFFF?text=Nintendo+Switch+4',
    ];

    function changeImage(index) {
      document.getElementById('main-image').src = images[index];
      document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
        thumb.classList.toggle('active', i === index);
      });
    }

    // Quantity and total
    function updateTotal() {
      const quantity = parseInt(document.getElementById('qty').value);
      const price = 8500;
      // Note: total price display removed from new layout
    }

    // Actions
    function handleAddToCart() {
      const quantity = document.getElementById('qty').value;
      alert(`已將 ${quantity} 件商品加入購物車`);
    }

    function handlePurchase() {
      // Check login
      const currentUser = getCurrentUser();
      if (!currentUser) {
        if (confirm('請先登入才能提出購買請求，是否前往登入頁面？')) {
          window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
        }
        return;
      }
      
      // Check if user is seller
      if (currentItem.sellerId === currentUser.id) {
        alert('無法對自己刊登的商品提出請求。');
        return;
      }
      
      // Show purchase confirmation modal
      const quantity = parseInt(document.getElementById('qty').value) || 1;
      const price = currentItem.price || 0;
      const total = price * quantity;
      const itemTitle = currentItem.title;
      
      // Create modal HTML
      const modalHTML = `
        <div class="modal-overlay" id="purchaseModal" style="display: flex;">
          <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
              <h2>確認購買</h2>
              <button class="modal-close" onclick="closePurchaseModal()">×</button>
            </div>
            <div class="modal-body">
              <div style="margin-bottom: 16px;">
                <strong>商品：</strong>${itemTitle}
              </div>
              <div style="margin-bottom: 16px;">
                <label>數量：</label>
                <select id="purchaseQuantity" style="margin-left: 8px; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 8px;">
                  ${Array.from({length: Math.min(currentItem.quantity || 1, 10)}, (_, i) => 
                    `<option value="${i+1}" ${i+1 === quantity ? 'selected' : ''}>${i+1}</option>`
                  ).join('')}
                </select>
              </div>
              <div style="margin-bottom: 16px;">
                <strong>單價：</strong>NT$ ${price.toLocaleString('zh-TW')}
              </div>
              <div style="margin-bottom: 16px; font-size: 18px; font-weight: 600; color: #2563eb;">
                <strong>總計：</strong>NT$ <span id="purchaseTotal">${total.toLocaleString('zh-TW')}</span>
              </div>
              <div class="form-group">
                <label for="purchaseNote">給賣家的訊息（選填）：</label>
                <textarea id="purchaseNote" placeholder="例如：希望週末面交" rows="3" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-family: inherit;"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn-secondary" onclick="closePurchaseModal()">取消</button>
              <button class="btn-primary" onclick="confirmPurchase()">確認購買</button>
            </div>
          </div>
        </div>
      `;
      
      // Remove existing modal if any
      const existingModal = document.getElementById('purchaseModal');
      if (existingModal) existingModal.remove();
      
      // Add modal to body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      // Update total when quantity changes
      document.getElementById('purchaseQuantity').addEventListener('change', function() {
        const qty = parseInt(this.value);
        const newTotal = price * qty;
        document.getElementById('purchaseTotal').textContent = newTotal.toLocaleString('zh-TW');
      });
    }
    
    function closePurchaseModal() {
      const modal = document.getElementById('purchaseModal');
      if (modal) modal.remove();
    }
    
    function confirmPurchase() {
      const quantity = parseInt(document.getElementById('purchaseQuantity').value);
      const note = document.getElementById('purchaseNote').value.trim();
      const currentUser = getCurrentUser();
      
      if (!currentUser || !currentItem) return;
      
      // Create purchase request
      const request = createRequest({
        itemId: currentItem.id,
        sellerId: currentItem.sellerId,
        buyerId: currentUser.id,
        type: 'purchase',
        quantity: quantity,
        note: note || undefined
      });
      
      // Create initial message if note provided
      if (note) {
        createMessage({
          itemId: currentItem.id,
          senderId: currentUser.id,
          receiverId: currentItem.sellerId,
          text: note
        });
      }
      
      closePurchaseModal();
      alert('已送出購買請求，請等待賣家回覆。');
    }

    // Trade modal state - single selection only
    let selectedItemId = null;

    function handleTrade() {
      // Check login
      const currentUser = getCurrentUser();
      if (!currentUser) {
        if (confirm('請先登入才能提出交換請求，是否前往登入頁面？')) {
          window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
        }
        return;
      }
      
      // Check if user is seller
      if (currentItem.sellerId === currentUser.id) {
        alert('無法對自己刊登的商品提出請求。');
        return;
      }
      
      // Load user's items for trade
      const userItems = getItemsBySeller(currentUser.id).filter(i => i.isActive);
      
      // Update trade modal content
      const tradeRequirementText = document.getElementById('tradeRequirementText');
      const itemsGrid = document.querySelector('.items-grid');
      
      if (currentItem.modes.tradeTarget && currentItem.tradeTargetNote) {
        if (tradeRequirementText) {
          tradeRequirementText.textContent = currentItem.tradeTargetNote;
        }
      } else if (currentItem.modes.tradeOpen) {
        if (tradeRequirementText) {
          tradeRequirementText.textContent = '賣家開放任何交換提案。';
        }
      }
      
      // Populate user items
      if (itemsGrid) {
        itemsGrid.innerHTML = '';
        if (userItems.length === 0) {
          itemsGrid.innerHTML = '<p style="color: #6b7280; padding: 20px; text-align: center;">你目前沒有可交換的商品。請先刊登商品。</p>';
        } else {
          userItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'trade-item-card item-card';
            card.dataset.itemId = item.id;
            card.onclick = () => selectTradeItem(card);
            card.innerHTML = `
              <img src="${item.images[0] || 'https://via.placeholder.com/150/f3f4f6/9ca3af?text=No+Image'}" alt="${item.title}" />
              <div class="item-card-title">${item.title}</div>
            `;
            itemsGrid.appendChild(card);
          });
        }
      }
      
      // Reset selection when opening modal
      selectedItemId = null;
      document.querySelectorAll('.trade-item-card').forEach(card => {
        card.classList.remove('selected');
      });
      updateSubmitButtonState();
      document.getElementById('trade-modal').style.display = 'flex';
    }

    function closeTradeModal() {
      document.getElementById('trade-modal').style.display = 'none';
      // Reset selection when closing
      selectedItemId = null;
      document.querySelectorAll('.trade-item-card').forEach(card => {
        card.classList.remove('selected');
      });
    }

    function selectTradeItem(card) {
      const itemId = card.dataset.itemId;
      
      // If clicking the same selected card, toggle it off
      if (selectedItemId === itemId) {
        card.classList.remove('selected');
        selectedItemId = null;
      } else {
        // Clear all selections
        document.querySelectorAll('.trade-item-card').forEach(c => {
          c.classList.remove('selected');
        });
        // Select only this card
        card.classList.add('selected');
        selectedItemId = itemId;
      }
      
      updateSubmitButtonState();
    }

    function updateSubmitButtonState() {
      const submitBtn = document.getElementById('submitTradeBtn');
      if (selectedItemId) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('disabled');
      } else {
        submitBtn.disabled = true;
        submitBtn.classList.add('disabled');
      }
    }

    function handleSubmitTrade() {
      if (!selectedItemId) {
        return;
      }

      const currentUser = getCurrentUser();
      if (!currentUser || !currentItem) return;

      const messageTextarea = document.getElementById('trade-message');
      const note = messageTextarea ? messageTextarea.value.trim() : '';

      // Determine request type
      let requestType = 'trade-open';
      if (currentItem.modes.tradeTarget) {
        requestType = 'trade-target';
      }

      // Create trade request
      const request = createRequest({
        itemId: currentItem.id,
        sellerId: currentItem.sellerId,
        buyerId: currentUser.id,
        type: requestType,
        quantity: 1,
        offeredItemId: selectedItemId,
        note: note || undefined
      });

      // Create initial message if note provided
      if (note) {
        createMessage({
          itemId: currentItem.id,
          senderId: currentUser.id,
          receiverId: currentItem.sellerId,
          text: note
        });
      }
      
      alert('交換提案已送出！賣家將收到通知。');
      closeTradeModal();
    }

    function handleOpenChat() {
      // Check login
      const currentUser = getCurrentUser();
      if (!currentUser) {
        if (confirm('請先登入才能聯絡賣家，是否前往登入頁面？')) {
          window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
        }
        return;
      }
      
      // Check if user is seller
      if (currentItem.sellerId === currentUser.id) {
        alert('無法對自己刊登的商品發送訊息。');
        return;
      }
      
      // Load messages for this conversation
      loadChatMessages();
      
      document.getElementById('chat-modal').style.display = 'flex';
      // Focus on input when modal opens
      setTimeout(() => {
        document.getElementById('chat-message').focus();
      }, 100);
    }
    
    function loadChatMessages() {
      const currentUser = getCurrentUser();
      if (!currentUser || !currentItem) return;
      
      const messages = getMessagesForConversation(
        currentItem.id,
        currentUser.id,
        currentItem.sellerId
      );
      
      const messagesArea = document.getElementById('messages-area');
      messagesArea.innerHTML = '';
      
      if (messages.length === 0) {
        messagesArea.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 20px;">與此商品相關的留言將會顯示在這裡。</div>';
      } else {
        messages.forEach(msg => {
          const isSender = msg.senderId === currentUser.id;
          const senderName = isSender ? '你' : (currentItem.seller?.name || '賣家');
          const bubble = document.createElement('div');
          bubble.className = `message-bubble ${isSender ? 'message-user' : 'message-seller'}`;
          
          const time = new Date(msg.createdAt);
          const timeStr = time.toLocaleString('zh-TW', { 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          bubble.innerHTML = `
            <div class="message-content">${msg.text}</div>
            <div class="message-time">${timeStr}</div>
          `;
          messagesArea.appendChild(bubble);
        });
      }
      
      // Scroll to bottom
      messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function closeChatModal() {
      document.getElementById('chat-modal').style.display = 'none';
      document.getElementById('chat-message').value = '';
    }

    function handleSendMessage(event) {
      if (event) {
        event.preventDefault();
      }
      const currentUser = getCurrentUser();
      if (!currentUser || !currentItem) return;
      
      const input = document.getElementById('chat-message');
      const messageText = input.value.trim();
      
      if (!messageText) {
        return;
      }

      // Create message in data layer
      createMessage({
        itemId: currentItem.id,
        senderId: currentUser.id,
        receiverId: currentItem.sellerId,
        text: messageText
      });
      
      // Reload messages to show new one
      loadChatMessages();
      
      // Clear input
      input.value = '';
    }

    // Allow Enter key to send message
    // Since script is at bottom of body, DOM is already loaded
    (function() {
      const chatInput = document.getElementById('chat-message');
      if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            handleSendMessage(e);
          }
        });
      }
    })();

    // messageButtonMain is already wired via onclick="handleOpenChat()" in HTML
    // No need for additional event listener

    // Mode handling logic (purchase + trade / trade only / wish only)
    (function() {
      // For now use hard-coded mode for the demo.
      // Later, this should come from backend or templating.
      const listingMode = 'purchase_and_trade';
      // options: 'purchase_and_trade', 'trade_only', 'wish_only'

      const listingModeSummary = document.getElementById('listingModeSummary');
      const actionPriceBlock = document.getElementById('actionPriceBlock');
      const btnAddToCart = document.getElementById('btnAddToCart');
      const btnBuyNow = document.getElementById('btnBuyNow');
      const btnTrade = document.getElementById('btnTrade');
      const actionQuantity = document.querySelector('.action-quantity');

      function applyMode() {
        if (listingMode === 'purchase_and_trade') {
          // Show price, show all buttons
          if (listingModeSummary) listingModeSummary.textContent = '可購買・可交換';
          if (actionPriceBlock) actionPriceBlock.style.display = 'block';
          if (btnAddToCart) btnAddToCart.style.display = 'block';
          if (btnBuyNow) btnBuyNow.style.display = 'block';
          if (btnTrade) btnTrade.style.display = 'block';
          if (actionQuantity) actionQuantity.style.display = 'flex';
        } else if (listingMode === 'trade_only') {
          // Hide price, hide purchase buttons, show trade only
          if (listingModeSummary) listingModeSummary.textContent = '僅接受以物易物';
          if (actionPriceBlock) {
            actionPriceBlock.innerHTML = `
              <div class="purchase-card-header">
                <span class="action-price-label">價格</span>
                <button
                  id="purchaseMoreBtn"
                  class="purchase-more-btn"
                  type="button"
                  aria-label="更多選項"
                >
                  ⋮
                </button>
                <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                  <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                    檢舉商品
                  </button>
                </div>
              </div>
              <div class="action-price" style="color: #6b7280; font-size: 14px;">僅接受以物易物</div>
            `;
            actionPriceBlock.style.display = 'block';
            // Re-attach event listeners after innerHTML update
            attachPurchaseMenuListeners();
          }
          if (btnAddToCart) btnAddToCart.style.display = 'none';
          if (btnBuyNow) btnBuyNow.style.display = 'none';
          if (btnTrade) btnTrade.style.display = 'block';
          if (actionQuantity) actionQuantity.style.display = 'none';
        } else if (listingMode === 'wish_only') {
          // Hide price, show wish message
          if (listingModeSummary) listingModeSummary.textContent = '開放式許願';
          if (actionPriceBlock) {
            actionPriceBlock.innerHTML = `
              <div class="purchase-card-header">
                <span class="action-price-label">價格</span>
                <button
                  id="purchaseMoreBtn"
                  class="purchase-more-btn"
                  type="button"
                  aria-label="更多選項"
                >
                  ⋮
                </button>
                <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                  <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                    檢舉商品
                  </button>
                </div>
              </div>
              <div class="action-price" style="color: #6b7280; font-size: 14px;">開放式許願</div>
            `;
            actionPriceBlock.style.display = 'block';
            // Re-attach event listeners after innerHTML update
            attachPurchaseMenuListeners();
          }
          if (btnAddToCart) btnAddToCart.style.display = 'none';
          if (btnBuyNow) btnBuyNow.style.display = 'none';
          if (btnTrade) btnTrade.style.display = 'block';
          if (actionQuantity) actionQuantity.style.display = 'none';
        }
      }

      // Apply mode on page load
      applyMode();
    })();
  </script>

  <script src="js/data.js"></script>
  <script src="js/navbar.js"></script>
  <script>
    // Get item ID from URL
    const params = new URLSearchParams(window.location.search);
    const itemId = params.get('id');
    let currentItem = null;
    
    if (itemId) {
      // Try new data layer first
      currentItem = getItemById(itemId);
      
      // If not found, try old mockItems (for backward compatibility)
      if (!currentItem && typeof mockItems !== 'undefined') {
        const oldItem = mockItems.find(i => String(i.id) === String(itemId));
        if (oldItem) {
          // Convert old format to new format
          currentItem = {
            id: String(oldItem.id),
            sellerId: 'u1', // Default seller
            title: oldItem.title,
            category: oldItem.category,
            condition: oldItem.condition,
            price: oldItem.price,
            description: oldItem.description?.main || '',
            tags: oldItem.tags || [],
            location: oldItem.location,
            quantity: 1,
            modes: {
              sale: oldItem.mode?.purchase || false,
              tradeTarget: oldItem.mode?.trade && (oldItem.mode?.tradeMode === 'target' || oldItem.mode?.tradeMode === 'both'),
              tradeOpen: oldItem.mode?.trade && (oldItem.mode?.tradeMode === 'offer' || oldItem.mode?.tradeMode === 'both')
            },
            tradeTargetNote: oldItem.mode?.tradeSummary || '',
            images: oldItem.images || [],
            views: oldItem.stats?.views || 0,
            addedToCartCount: oldItem.stats?.watchers || 0,
            isActive: true
          };
          
          // Get seller info from old format
          if (oldItem.seller) {
            currentItem.seller = oldItem.seller;
          }
        }
      }
    }

    if (!currentItem) {
      document.body.innerHTML = '<div style="padding: 40px; text-align: center;"><h1>商品不存在</h1><p><a href="item_list.html">返回商品列表</a></p></div>';
    } else {
      // Increment view count
      if (currentItem.id) {
        updateItem(currentItem.id, { views: (currentItem.views || 0) + 1 });
        currentItem.views = (currentItem.views || 0) + 1;
      }
      
      // Get seller info
      if (!currentItem.seller && currentItem.sellerId) {
        const seller = getUsers().find(u => u.id === currentItem.sellerId);
        if (seller) {
          currentItem.seller = {
            name: seller.name,
            rating: 4.8,
            ratingText: '99.9% 好評',
            deals: 0
          };
        }
      }
      
      if (!currentItem.seller) {
        currentItem.seller = {
          name: 'Unknown',
          rating: 0,
          ratingText: '無評價',
          deals: 0
        };
      }
      // Track recently viewed items
      (function() {
        try {
          let recentlyViewed = JSON.parse(localStorage.getItem('recentlyViewedItems') || '[]');
          
          // Remove duplicate if exists (compare as strings to handle type mismatches)
          const currentItemIdStr = String(currentItem.id);
          recentlyViewed = recentlyViewed.filter(item => String(item.id) !== currentItemIdStr);
          
          // Add current item to front
          const itemData = {
            id: String(currentItem.id), // Ensure ID is stored as string consistently
            title: currentItem.title,
            price: currentItem.mode.purchase ? currentItem.price : null,
            imageUrl: currentItem.images && currentItem.images.length > 0 ? currentItem.images[0] : '',
            condition: currentItem.condition,
            mode: {
              purchase: currentItem.mode.purchase,
              trade: currentItem.mode.trade,
              wish: currentItem.mode.wish
            }
          };
          
          recentlyViewed.unshift(itemData);
          
          // Limit to max 8 items
          if (recentlyViewed.length > 8) {
            recentlyViewed = recentlyViewed.slice(0, 8);
          }
          
          // Save back to localStorage
          localStorage.setItem('recentlyViewedItems', JSON.stringify(recentlyViewed));
        } catch (e) {
          console.error('Error saving recently viewed items:', e);
        }
      })();
      // Normalize item format for compatibility
      function normalizeItem(item) {
        // Convert new format to old format for display compatibility
        if (item.modes) {
          item.mode = {
            purchase: item.modes.sale || false,
            trade: item.modes.tradeTarget || item.modes.tradeOpen || false,
            wish: item.modes.tradeOpen || false,
            tradeMode: item.modes.tradeTarget && item.modes.tradeOpen ? 'both' :
                      item.modes.tradeTarget ? 'target' :
                      item.modes.tradeOpen ? 'offer' : null,
            tradeSummary: item.tradeTargetNote || ''
          };
        }
        
        // Convert description from string to object format if needed
        if (typeof item.description === 'string') {
          item.description = {
            main: item.description,
            includes: [],
            conditionDetails: [],
            extra: ''
          };
        }
        
        // Ensure stats object exists
        if (!item.stats) {
          item.stats = {
            views: item.views || 0,
            watchers: item.addedToCartCount || 0
          };
        }
        
        // Ensure pickup object exists
        if (!item.pickup) {
          item.pickup = {
            type: '面交',
            place: item.location || '未指定',
            time: '時間可議'
          };
        }
        
        return item;
      }
      
      // Normalize current item
      currentItem = normalizeItem(currentItem);
      
      // Populate page with currentItem data
      function populateItemPage() {
        // Title
        document.getElementById('itemTitle').textContent = currentItem.title;

        // Seller info
        document.getElementById('sellerName').textContent = currentItem.seller.name;
        document.getElementById('sellerCount').textContent = `(${currentItem.seller.deals || 0})`;
        document.getElementById('sellerRatingText').textContent = currentItem.seller.ratingText || '無評價';
        document.getElementById('sellerAvatar').querySelector('span').textContent = currentItem.seller.name[0].toUpperCase();
        
        // Wire up seller buttons
        const sellerViewItemsButton = document.getElementById('sellerViewItemsButton');
        if (sellerViewItemsButton) {
          sellerViewItemsButton.addEventListener('click', () => {
            window.location.href = `item_list.html?seller=${encodeURIComponent(currentItem.seller.name)}`;
          });
        }

        // Condition badge
        document.getElementById('conditionBadge').textContent = currentItem.condition;
        document.getElementById('itemCondition').textContent = currentItem.condition;

        // Location
        document.getElementById('itemLocation').textContent = currentItem.location;

        // Tags
        const tagsContainer = document.getElementById('itemTags');
        tagsContainer.innerHTML = '';
        currentItem.tags.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'tag-pill';
          span.textContent = tag;
          tagsContainer.appendChild(span);
        });

        // Images
        const mainImage = document.getElementById('main-image');
        if (currentItem.images && currentItem.images.length > 0) {
          mainImage.src = currentItem.images[0];
          mainImage.alt = currentItem.title;

          // Update thumbnails
          const thumbnailContainer = document.querySelector('.item-thumbnails');
          if (thumbnailContainer) {
            thumbnailContainer.innerHTML = '';
            currentItem.images.forEach((img, index) => {
              const button = document.createElement('button');
              button.className = `thumbnail ${index === 0 ? 'active' : ''}`;
              button.onclick = () => changeImage(index);
              button.innerHTML = `<img src="${img}" alt="View ${index + 1}" />`;
              thumbnailContainer.appendChild(button);
            });
          }
        }

        // Price (only in action card, not in header)
        const actionPrice = document.getElementById('actionPrice');
        if (currentItem.mode.purchase && actionPrice) {
          actionPrice.textContent = `NT$ ${currentItem.price.toLocaleString('zh-TW')}`;
        }

        // Mode badges
        const badgesContainer = document.getElementById('tradeModeBadges');
        badgesContainer.innerHTML = '';
        if (currentItem.mode.purchase) {
          const badge = document.createElement('span');
          badge.className = 'badge mode-sale';
          badge.textContent = '販售中';
          badgesContainer.appendChild(badge);
        }
        if (currentItem.mode.trade) {
          const badge = document.createElement('span');
          badge.className = 'badge mode-trade';
          if (currentItem.mode.tradeMode === 'target') {
            badge.textContent = '可交換（指定目標）';
          } else if (currentItem.mode.tradeMode === 'offer') {
            badge.className = 'badge mode-wish';
            badge.textContent = '開放式許願';
          } else {
            badge.textContent = '可交換（指定目標）';
            const badge2 = document.createElement('span');
            badge2.className = 'badge mode-wish';
            badge2.textContent = '開放式許願';
            badgesContainer.appendChild(badge2);
          }
          badgesContainer.appendChild(badge);
        }
        if (currentItem.mode.wish && !currentItem.mode.trade) {
          const badge = document.createElement('span');
          badge.className = 'badge mode-wish';
          badge.textContent = '開放式許願';
          badgesContainer.appendChild(badge);
        }

        // Trade summary line removed - only blue trade-rule-card shows trade info now

        // Trade rule card
        const tradeRuleBody = document.getElementById('tradeRuleBody');
        if (currentItem.mode.trade && currentItem.mode.tradeSummary) {
          tradeRuleBody.innerHTML = `<p><strong>想換：</strong>${currentItem.mode.tradeSummary}</p>`;
          if (currentItem.mode.tradeMode === 'offer' || currentItem.mode.tradeMode === 'both') {
            tradeRuleBody.innerHTML += '<p>也接受開放交換，買家可提出任何商品提案</p>';
          }
        } else {
          document.getElementById('tradeRuleCard').style.display = 'none';
        }

        // Description
        const descContainer = document.getElementById('itemDescription');
        if (descContainer) {
        descContainer.innerHTML = '';
        
          // Handle both string and object formats
          if (typeof currentItem.description === 'string') {
            const mainP = document.createElement('p');
            mainP.textContent = currentItem.description;
            descContainer.appendChild(mainP);
          } else if (currentItem.description && typeof currentItem.description === 'object') {
            if (currentItem.description.main) {
        const mainP = document.createElement('p');
        mainP.textContent = currentItem.description.main;
        descContainer.appendChild(mainP);
            }

        if (currentItem.description.includes && currentItem.description.includes.length > 0) {
          const includesP = document.createElement('p');
          includesP.innerHTML = '<strong>包含：</strong>';
          descContainer.appendChild(includesP);
          const includesUl = document.createElement('ul');
          currentItem.description.includes.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            includesUl.appendChild(li);
          });
          descContainer.appendChild(includesUl);
        }

        if (currentItem.description.conditionDetails && currentItem.description.conditionDetails.length > 0) {
          const conditionP = document.createElement('p');
          conditionP.innerHTML = '<strong>外觀狀況：</strong>';
          descContainer.appendChild(conditionP);
          const conditionUl = document.createElement('ul');
          currentItem.description.conditionDetails.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            conditionUl.appendChild(li);
          });
          descContainer.appendChild(conditionUl);
        }

        if (currentItem.description.extra) {
          const extraP = document.createElement('p');
          extraP.textContent = currentItem.description.extra;
          descContainer.appendChild(extraP);
            }
          }
        }

        // Stats
        document.getElementById('viewStats').textContent = 
          `瀏覽次數：${currentItem.stats.views}　追蹤人數：${currentItem.stats.watchers}`;

        // Pickup info
        document.getElementById('pickupInfo').textContent = 
          `${currentItem.pickup.type} | ${currentItem.pickup.place} | ${currentItem.pickup.time}`;

        // Trade hint removed - information is in the blue 交換規則 card

        // Update trade modal requirement text
        const tradeReqText = document.getElementById('tradeRequirementText');
        if (tradeReqText && currentItem.mode.tradeSummary) {
          tradeReqText.textContent = currentItem.mode.tradeSummary;
        }

        // Update chat modal seller info
        const chatSellerName = document.getElementById('chatSellerName');
        const chatSellerAvatar = document.getElementById('chatSellerAvatar');
        if (chatSellerName) chatSellerName.textContent = currentItem.seller.name;
        if (chatSellerAvatar) chatSellerAvatar.textContent = currentItem.seller.name[0].toUpperCase();

        // Apply listing mode
        let listingMode = 'purchase_and_trade';
        if (!currentItem.mode.purchase && currentItem.mode.trade && !currentItem.mode.wish) {
          listingMode = 'trade_only';
        } else if (!currentItem.mode.purchase && currentItem.mode.wish) {
          listingMode = 'wish_only';
        }

        // Update mode handling
        const listingModeSummary = document.getElementById('listingModeSummary');
        const actionPriceBlock = document.getElementById('actionPriceBlock');
        const btnAddToCart = document.getElementById('btnAddToCart');
        const btnBuyNow = document.getElementById('btnBuyNow');
        const btnTrade = document.getElementById('btnTrade');
        const actionQuantity = document.querySelector('.action-quantity');

        if (listingMode === 'purchase_and_trade') {
          if (listingModeSummary) {
            listingModeSummary.textContent = '可購買・可交換';
          }
          if (actionPriceBlock) {
            actionPriceBlock.innerHTML = `
              <div class="purchase-card-header">
              <span class="action-price-label">價格</span>
                <button
                  id="purchaseMoreBtn"
                  class="purchase-more-btn"
                  type="button"
                  aria-label="更多選項"
                >
                  ⋮
                </button>
                <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                  <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                    檢舉商品
                  </button>
                </div>
              </div>
              <div class="action-price">NT$ ${currentItem.price.toLocaleString('zh-TW')}</div>
            `;
            actionPriceBlock.style.display = 'block';
            // Re-attach event listeners after innerHTML update
            attachPurchaseMenuListeners();
          }
          if (btnAddToCart) btnAddToCart.style.display = 'block';
          if (btnBuyNow) btnBuyNow.style.display = 'block';
          if (btnTrade) btnTrade.style.display = 'block';
          if (actionQuantity) actionQuantity.style.display = 'flex';
        } else if (listingMode === 'trade_only') {
          if (listingModeSummary) {
            listingModeSummary.textContent = '僅接受以物易物';
          }
          if (actionPriceBlock) {
            actionPriceBlock.innerHTML = `
              <div class="purchase-card-header">
                <span class="action-price-label">價格</span>
                <button
                  id="purchaseMoreBtn"
                  class="purchase-more-btn"
                  type="button"
                  aria-label="更多選項"
                >
                  ⋮
                </button>
                <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                  <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                    檢舉商品
                  </button>
                </div>
              </div>
              <div class="action-price" style="color: #6b7280; font-size: 14px;">僅接受以物易物</div>
            `;
            actionPriceBlock.style.display = 'block';
            // Re-attach event listeners after innerHTML update
            attachPurchaseMenuListeners();
          }
          if (btnAddToCart) btnAddToCart.style.display = 'none';
          if (btnBuyNow) btnBuyNow.style.display = 'none';
          if (btnTrade) btnTrade.style.display = 'block';
          if (actionQuantity) actionQuantity.style.display = 'none';
        } else if (listingMode === 'wish_only') {
          if (listingModeSummary) {
            listingModeSummary.textContent = '開放式許願';
          }
          if (actionPriceBlock) {
            actionPriceBlock.innerHTML = `
              <div class="purchase-card-header">
                <span class="action-price-label">價格</span>
                <button
                  id="purchaseMoreBtn"
                  class="purchase-more-btn"
                  type="button"
                  aria-label="更多選項"
                >
                  ⋮
                </button>
                <div id="purchaseMoreMenu" class="purchase-more-menu" hidden>
                  <button id="reportItemBtn" type="button" class="purchase-more-menu-item">
                    檢舉商品
                  </button>
                </div>
              </div>
              <div class="action-price" style="color: #6b7280; font-size: 14px;">開放式許願</div>
            `;
            actionPriceBlock.style.display = 'block';
            // Re-attach event listeners after innerHTML update
            attachPurchaseMenuListeners();
          }
          if (btnAddToCart) btnAddToCart.style.display = 'none';
          if (btnBuyNow) btnBuyNow.style.display = 'none';
          if (btnTrade) {
            btnTrade.style.display = 'block';
            btnTrade.textContent = '提出交換提案';
          }
          if (actionQuantity) actionQuantity.style.display = 'none';
        }

        // Update image gallery function to use currentItem images
        window.currentItemImages = currentItem.images || [];
      }

      // Update changeImage function to work with dynamic images
      const originalChangeImage = window.changeImage;
      window.changeImage = function(index) {
        if (window.currentItemImages && window.currentItemImages[index]) {
          document.getElementById('main-image').src = window.currentItemImages[index];
          document.querySelectorAll('.thumbnail').forEach((thumb, i) => {
            thumb.classList.toggle('active', i === index);
          });
        } else if (originalChangeImage) {
          originalChangeImage(index);
        }
      };

      // Populate on load
      populateItemPage();
    }

    // Handle header search
    function handleHeaderSearch() {
      const keyword = document.getElementById('headerSearchInput').value.trim();
      const params = new URLSearchParams();
      if (keyword) params.set('q', keyword);
      window.location.href = 'item_list.html?' + params.toString();
    }

    // Allow Enter key in header search
    (function() {
      const headerSearchInput = document.getElementById('headerSearchInput');
      if (headerSearchInput) {
        headerSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            handleHeaderSearch();
          }
        });
      }
    })();

    // Helper function to attach purchase menu listeners
    function attachPurchaseMenuListeners() {
      const moreBtn = document.getElementById('purchaseMoreBtn');
      const moreMenu = document.getElementById('purchaseMoreMenu');
      const reportBtn = document.getElementById('reportItemBtn');

      if (moreBtn && moreMenu) {
        // Remove existing listeners if any (by cloning and replacing)
        const newMoreBtn = moreBtn.cloneNode(true);
        moreBtn.parentNode.replaceChild(newMoreBtn, moreBtn);
        
        newMoreBtn.addEventListener('click', function (event) {
          event.stopPropagation();
          moreMenu.hidden = !moreMenu.hidden;
        });
      }

      if (reportBtn) {
        // Remove existing listeners if any
        const newReportBtn = reportBtn.cloneNode(true);
        reportBtn.parentNode.replaceChild(newReportBtn, reportBtn);
        
        newReportBtn.addEventListener('click', function () {
          moreMenu.hidden = true;
          // For now just show a confirmation; in a real system we would call an API
          alert('已收到你的檢舉，我們會儘快處理，謝謝你的協助。');
        });
      }
    }

    // Three-dot menu functionality
    document.addEventListener('DOMContentLoaded', function () {
      attachPurchaseMenuListeners();

      // Click outside to close
      document.addEventListener('click', function (event) {
        const moreMenu = document.getElementById('purchaseMoreMenu');
        const moreBtn = document.getElementById('purchaseMoreBtn');
        if (moreMenu && moreBtn && !moreMenu.contains(event.target) && !moreBtn.contains(event.target)) {
          moreMenu.hidden = true;
        }
      });
    });
  </script>
</body>
</html>

