# 資料庫備份說明

## 資料庫類型

本系統使用兩種資料庫：

### 1. PostgreSQL（關聯式資料庫）
- **位置**: 本地 PostgreSQL 伺服器
- **預設配置**:
  - Host: `localhost`
  - Port: `5432`
  - Database: `campus_trading`（可在 `.backend/.env` 中設定）
  - User: `postgres`（可在 `.backend/.env` 中設定）

### 2. MongoDB（NoSQL 資料庫）
- **位置**: 
  - 本地 MongoDB 伺服器（預設）
  - 或 MongoDB Atlas（雲端，如果設定了 `MONGO_URI`）
- **預設配置**:
  - Host: `localhost`
  - Port: `27017`
  - Database: `campus_trading_nosql`（可在 `.backend/.env` 中設定）

## 備份方法

### 方法一：使用自動備份腳本（推薦）

#### Windows 系統
```bash
# 進入後端目錄
cd .backend

# 執行備份腳本
backup_databases.bat
```

或直接執行 Python 腳本：
```bash
python backup_databases.py
```

#### 備份檔案位置
備份檔案會存放在專案根目錄的 `database_backups/` 資料夾中：
- PostgreSQL: `postgresql_campus_trading_YYYYMMDD_HHMMSS.sql` 或 `.dump`
- MongoDB: `mongodb_campus_trading_nosql_YYYYMMDD_HHMMSS/` 或 `.json`

### 方法二：手動備份 PostgreSQL

#### 使用 pg_dump（推薦，產生壓縮備份）
```bash
# 設定環境變數（Windows PowerShell）
$env:PGPASSWORD="你的密碼"

# 執行備份
pg_dump -h localhost -p 5432 -U postgres -d campus_trading -F c -f backup.dump

# 或使用 SQL 格式（未壓縮，但可讀）
pg_dump -h localhost -p 5432 -U postgres -d campus_trading -f backup.sql
```

#### 使用 psql（匯出為 SQL）
```bash
# 匯出整個資料庫
pg_dump -h localhost -p 5432 -U postgres campus_trading > backup.sql

# 只匯出結構（不含資料）
pg_dump -h localhost -p 5432 -U postgres -s campus_trading > schema_only.sql

# 只匯出資料（不含結構）
pg_dump -h localhost -p 5432 -U postgres -a campus_trading > data_only.sql
```

### 方法三：手動備份 MongoDB

#### 本地 MongoDB
```bash
# 使用 mongodump（推薦）
mongodump --host localhost:27017 --db campus_trading_nosql --out ./backup

# 匯出為 JSON 格式
mongoexport --host localhost:27017 --db campus_trading_nosql --collection collection_name --out backup.json
```

#### MongoDB Atlas（雲端）
1. 登入 [MongoDB Atlas](https://cloud.mongodb.com/)
2. 選擇您的 Cluster
3. 點擊「...」選單 → 「Export」
4. 選擇要匯出的集合
5. 下載備份檔案

或使用命令列：
```bash
mongodump --uri="你的MongoDB Atlas連接字串" --out ./backup
```

## 還原資料庫

### PostgreSQL 還原

#### 從 .dump 檔案還原（壓縮格式）
```bash
pg_restore -h localhost -p 5432 -U postgres -d campus_trading -c backup.dump
```

#### 從 .sql 檔案還原
```bash
psql -h localhost -p 5432 -U postgres -d campus_trading < backup.sql
```

### MongoDB 還原

#### 從備份目錄還原
```bash
mongorestore --host localhost:27017 --db campus_trading_nosql ./backup/campus_trading_nosql
```

#### 從 JSON 檔案還原
```bash
mongoimport --host localhost:27017 --db campus_trading_nosql --collection collection_name --file backup.json
```

## 檢查資料庫資訊

### 查看 PostgreSQL 資料庫大小
```sql
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database
WHERE datname = 'campus_trading';
```

### 查看各資料表大小
```sql
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### 查看 MongoDB 集合資訊
```javascript
// 在 MongoDB shell 中執行
use campus_trading_nosql
db.stats()
db.getCollectionNames()
```

## 注意事項

1. **備份前請確認資料庫服務正在運行**
2. **備份檔案可能很大，請確保有足夠的磁碟空間**
3. **建議定期備份，特別是重要資料更新後**
4. **備份檔案包含敏感資訊，請妥善保管**
5. **MongoDB Atlas 備份需要網路連線**

## 快速備份指令（Windows）

建立一個批次檔 `快速備份.bat` 在專案根目錄：

```batch
@echo off
cd .backend
python backup_databases.py
pause
```

執行此批次檔即可快速備份所有資料庫。



