# 軟刪除功能說明

## 功能概述

已將帳號刪除功能從「完全刪除」改為「軟刪除」，刪除帳號後：
- 帳號在後台仍然可見，但會顯示「(已刪除)」標記
- 該用戶給別人的評價、交易紀錄等資料都會保留
- 該用戶無法再登入帳號
- 別人無法再跟他聯繫和買他的東西
- 該用戶現有的商品會全部被下架（狀態改為 `removed`）
- 如果有人點進與他的對話紀錄，會顯示他的名稱然後「(已刪除)」，無法和他聊天

## 資料庫變更

需要在資料庫中添加 `deleted_at` 欄位到 `user` 表。

## 執行遷移

### 方法一：使用 Python 腳本（推薦）

```bash
cd .backend
python database/add_deleted_at_migration.py
```

### 方法二：手動執行 SQL

連接到 PostgreSQL 資料庫後，執行：

```sql
-- 添加 deleted_at 欄位到 user 表
ALTER TABLE "user" 
ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMP DEFAULT NULL;

-- 添加索引以優化查詢
CREATE INDEX IF NOT EXISTS idx_user_deleted_at ON "user"(deleted_at);

-- 添加註釋
COMMENT ON COLUMN "user".deleted_at IS '帳號刪除時間，NULL 表示未刪除';
```

## 功能變更詳情

### 1. 刪除帳號 API (`DELETE /api/auth/delete-account`)
- 改為軟刪除：設置 `deleted_at = CURRENT_TIMESTAMP`
- 下架該用戶的所有商品（狀態改為 `removed`）
- 保留所有歷史資料（交易紀錄、評價、訊息等）

### 2. 登入 API (`POST /api/auth/login`)
- 檢查 `deleted_at IS NULL`，已刪除帳號無法登入

### 3. 商品查詢 API (`GET /api/products`)
- 自動過濾已刪除用戶的商品（`u.deleted_at IS NULL`）

### 4. 商品詳情 API (`GET /api/products/<id>`)
- 如果商品擁有者已刪除，在 `owner_name` 後加上「(已刪除)」
- 返回 `owner_deleted: true/false` 欄位

### 5. 訊息 API (`POST /api/messages`, `GET /api/messages/request/<id>`)
- 阻止向已刪除用戶發送訊息
- 在訊息列表中顯示「(已刪除)」標記

### 6. 交易請求 API (`GET /api/trade-requests`)
- 在交易請求列表中顯示「(已刪除)」標記
- 阻止對已刪除用戶的商品發起請求

### 7. 後台管理 API (`GET /api/admin/users`)
- 顯示所有用戶，包括已刪除的
- 已刪除用戶的 `user_name` 會加上「(已刪除)」
- 返回 `deleted_at` 和 `is_deleted` 欄位

## 注意事項

1. **已刪除帳號的資料保留**：所有歷史資料（交易紀錄、評價、訊息等）都會保留，只是該用戶無法再登入和使用系統。

2. **商品自動下架**：刪除帳號時，該用戶的所有 `available` 和 `reserved` 狀態的商品會自動改為 `removed` 狀態。

3. **無法聯繫**：已刪除帳號的用戶無法接收新訊息，也無法對其商品發起新的交易請求。

4. **後台可見**：管理員在後台仍然可以看到已刪除的帳號，方便查看歷史資料。



